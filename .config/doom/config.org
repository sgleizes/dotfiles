#+title: Doom Emacs Configuration
#+author: St√©phane Gleizes
#+startup: overview
#+property: header-args:elisp :tangle yes :cache yes :results silent :comments link
#+property: header-args :tangle no :results silent

* System setup
** Systemd daemons

To avoid the loads of issues arising when using a single ~emacs~ daemon for both
terminal and graphical frames, I decided to use dedicated daemons for each type
of frame.

To that purpose, I created a systemd /template unit file/, derived from the default
one that ships with ~emacs~:
#+begin_src systemd :tangle ~/.config/systemd/user/emacs@.service :mkdirp yes
[Unit]
Description=Emacs text editor (%i)
Documentation=info:emacs man:emacs(1) https://gnu.org/software/emacs/
PartOf=emacs.target

[Service]
Type=notify
ExecStart=/usr/bin/emacs --fg-daemon=%i
ExecStop=/usr/bin/emacsclient --socket-name=%i --eval "(kill-emacs)"
# The location of the SSH auth socket varies by distribution, and some
# set it from PAM, so don't override by default.
# Environment=SSH_AUTH_SOCK=%t/keyring/ssh
Restart=on-failure
Nice=-10

[Install]
WantedBy=default.target
#+end_src

This unit file is extended by the following /drop-in snippet/ that sets-up the
right environment for ~emacs~ daemons:
#+begin_src systemd :tangle ~/.config/systemd/user/emacs@.service.d/env.conf :mkdirp yes
[Service]
Environment=XAUTHORITY=%C/Xauthority
Environment=DOOMDIR=%E/doom
Environment=DOOMLOCALDIR=%h/.local/share/emacs
#+end_src

To define and manage all instances, I use a systemd /target file/:
#+begin_src systemd :tangle ~/.config/systemd/user/emacs.target :mkdirp yes
[Unit]
Description=Emacs text editor daemons
Wants=emacs@terminal.service emacs@graphical.service

[Install]
WantedBy=default.target
#+end_src

Which is then enabled and started with:
#+begin_src sh
systemctl --user enable --now emacs.target
#+end_src

** Desktop launcher

Since I don't want a new graphical frame to be created every time a file is
opened, I wrote this launcher script to wrap ~emacsclient~:
#+begin_src sh :tangle ~/.local/bin/emacs-xclient :tangle-mode (identity #o755)
#!/usr/bin/env bash
# Wrap the emacsclient command to open a new graphical frame if none exist or if
# no files are specified, else open the given files in the most-recent graphical
# frame.

# The command to use to contact the emacs server.
EMACSCLIENT="emacsclient --socket-name graphical"

# Elisp query to find the most recently opened graphical non-child frame.
FRAME_QUERY="car (filtered-frame-list #'(lambda (f) \
  (and (eq (framep f) 'x) \
  (not (frame-parent f)))))"

if [[ ! $* || "$($EMACSCLIENT --eval "($FRAME_QUERY)")" == 'nil' ]]; then
  $EMACSCLIENT --create-frame --no-wait
else
  DISPLAY=$($EMACSCLIENT --eval "(frame-parameter ($FRAME_QUERY) 'display)")
  $EMACSCLIENT --display "${DISPLAY//\"/}" --no-wait "$@"
fi
#+end_src

Let's add a new desktop icon that represents well what ~emacs~ truly is: a black
hole for the mind:
#+attr_html: :class img :alt The doom emacs desktop icon
[[file:./icon/black-hole.png]]

Install the icon:
#+begin_src sh
for size in 16 24 32 48 64 96 128 192 256; do
  orig="./icon/black-hole.png"
  icon="./icon/black-hole-$size.png"
  convert "$orig" -resize "${size}x${size}" "$icon"
  xdg-icon-resource install --size "$size" "$icon" doom-emacs
  rm -f "$icon"
done
#+end_src

The desktop entry must now be modified to use the above script and icon:
#+begin_src conf :tangle ~/.local/share/applications/emacs.desktop :mkdirp yes
[Desktop Entry]
Categories=Development;TextEditor;
Comment=Edit text
Exec=emacs-xclient %F
GenericName=Text Editor
Icon=doom-emacs
Keywords=Text;Editor;
MimeType=text/x-tex;text/x-pascal;text/x-moc;text/x-makefile;text/x-java;text/x-csrc;text/x-csrc;text/x-chdr;text/x-c++src;text/x-c++hdr;text/tcl;text/plain;application/x-shellscript;
Name=Emacs
StartupNotify=true
StartupWMClass=Emacs
Terminal=false
Type=Application
#+end_src

** Ediff launcher

Add another launcher script to start an ~ediff~ session in a new graphical frame.

Note that it depends on a ~+workspace/rename-frame~ function that automatically
generates a unique name for the new perspective (workspace).
#+begin_src sh :tangle ~/.local/bin/ediff :tangle-mode (identity #o755)
#!/usr/bin/env bash
# Start an ediff session in a new emacs frame. Inspired by:
# https://gist.github.com/ptrv/0b460291e14a4a3c6372
#
# This script can be used as a `git mergetool` and `git difftool`.
# It automatically detects whether to run a diff/merge session
# and also supports directories.

# Abort if arguments are not provided.
if [ ! ${#} -ge 2 ]; then
  echo >&2 "Usage: ediff <local> <remote> [merged] [base]"
  exit 1
fi

# Process arguments.
LOCAL="$1"
REMOTE="$2"
[[ $3 ]] && MERGED="$3" || MERGED="$REMOTE"
[[ -d $LOCAL && -d $REMOTE ]] && MODE='directories' || MODE='files'

# Determine the emacs command to evaluate.
if [[ $4 && -r $4 ]]; then
  BASE="$4"
  EVAL="ediff-merge-$MODE-with-ancestor \"$LOCAL\" \"$REMOTE\" \"$BASE\" nil \"$MERGED\""
elif [[ $REMOTE != "$MERGED" ]]; then
  EVAL="ediff-merge-$MODE \"$LOCAL\" \"$REMOTE\" nil \"$MERGED\""
else
  EVAL="ediff-$MODE \"$LOCAL\" \"$REMOTE\" nil"
fi

# Use a graphical frame except in the console.
if [[ $TERM == 'linux' ]]; then
  EMACSCLIENT_OPTS="--socket-name terminal --tty"
else
  EMACSCLIENT_OPTS="--socket-name graphical --create-frame"
fi

# Run emacsclient.
emacsclient $EMACSCLIENT_OPTS --eval "
  (progn
    (+workspace/rename-frame \"ediff\")
    ($EVAL))"

# Check modified file for unresolved conflicts.
if [[ $MODE == 'files' && $(egrep -c '^(<<<<<<<|=======|>>>>>>>|####### Ancestor)' "$MERGED") != 0 ]]; then
  MERGEDSAVE=$(mktemp --tmpdir "$(basename "$MERGED").XXXXXXXX")
  cp "$MERGED" "$MERGEDSAVE"
  echo >&2 "Oops! Conflict markers detected in $MERGED"
  echo >&2 "Saved your changes to $MERGEDSAVE"
  exit 1
fi
#+end_src

* General configuration

Make this file run (slightly) faster with lexical binding (see [[https://nullprogram.com/blog/2016/12/22/][this blog post]]
for more info).
#+begin_src elisp :comments no
;;; config.el -*- lexical-binding: t; -*-
#+end_src

** Personal information

Some functionality uses this to identify you, e.g. GPG configuration, email
clients, file templates and snippets.
#+begin_src elisp
(setq user-full-name "St√©phane Gleizes"
      user-mail-address "stephane.gleizes@gmail.com")
#+end_src

** Doom configuration
*** Modules
:PROPERTIES:
:header-args:elisp: :tangle no
:END:

Doom has this lovely /modular configuration base/ that takes a lot of work out
of configuring Emacs. Each module (when enabled) can provide a list of packages
to install (on ~doom sync~) and configuration to be applied. The modules can
also have flags applied to tweak their behavior.

See the [[https://github.com/hlissner/doom-emacs/blob/develop/docs/getting_started.org#modules][doom documentation]] and the [[https://github.com/hlissner/doom-emacs/blob/develop/docs/modules.org][modules appendix]].

**** Structure

#+name: init.el
#+begin_src elisp :tangle "init.el" :noweb no-export :comments no
;;; init.el -*- lexical-binding: t; -*-

;; This file controls what Doom modules are enabled and what order they load in.
;; Press 'K' on a module to view its documentation, and 'gd' to browse its directory.

(doom! :input
       <<doom-input>>

       :completion
       <<doom-completion>>

       :ui
       <<doom-ui>>

       :editor
       <<doom-editor>>

       :emacs
       <<doom-emacs>>

       :term
       <<doom-term>>

       :checkers
       <<doom-checkers>>

       :tools
       <<doom-tools>>

       :os
       <<doom-os>>

       :lang
       <<doom-lang>>

       :email
       <<doom-email>>

       :app
       <<doom-app>>

       :config
       <<doom-config>>
       )
#+end_src

**** Configuration

#+name: doom-config
#+begin_src elisp
literate
(default +bindings +smartparens)
#+end_src

#+name: doom-input
#+begin_src elisp
;;chinese
;;japanese
;;layout                      ; auie,ctsrnm is the superior home row
#+end_src

**** Completion

#+name: doom-completion
#+begin_src elisp
(company +childframe)         ; the ultimate code completion backend
;;helm                        ; the *other* search engine for love and life
;;ido                         ; the other *other* search engine...
(ivy +prescient +icons)       ; a search engine for love and life
#+end_src

**** Interface

#+name: doom-ui
#+begin_src elisp
;;deft                        ; notational velocity for Emacs
doom                          ; what makes DOOM look the way it does
doom-dashboard                ; a nifty splash screen for Emacs
;;doom-quit                   ; DOOM quit-message prompts when you quit Emacs
;;fill-column                 ; a `fill-column' indicator
hl-todo                       ; highlight TODO/FIXME/NOTE/DEPRECATED/HACK/REVIEW
hydra
;;indent-guides               ; highlighted indent columns
(ligatures +fira)             ; ligatures and symbols to make your code pretty again
;;minimap                     ; show a map of the code on the side
modeline                      ; snazzy, Atom-inspired modeline, plus API
;;nav-flash                   ; blink cursor line after big motions
;;neotree                     ; a project drawer, like NERDTree for vim
ophints                       ; highlight the region an operation acts on
(popup +all +defaults)        ; tame sudden yet inevitable temporary windows
tabs                          ; a tab bar for Emacs
treemacs                      ; a project drawer, like neotree but cooler
unicode                       ; extended unicode support for various languages
vc-gutter                     ; vcs diff in the fringe
vi-tilde-fringe               ; fringe tildes to mark beyond EOB
(window-select +numbers)      ; visually switch windows
workspaces                    ; tab emulation, persistence & separate workspaces
;;zen                         ; distraction-free coding or writing
#+end_src

**** Editor

#+name: doom-editor
#+begin_src elisp
(evil +everywhere)            ; come to the dark side, we have cookies
file-templates                ; auto-snippets for empty files
fold                          ; (nigh) universal code folding
(format +onsave)              ; automated prettiness
;;god                         ; run Emacs commands without modifier keys
;;lispy                       ; vim for lisp, for people who don't like vim
multiple-cursors              ; editing in many places at once
;;objed                       ; text object editing for the innocent
;;parinfer                    ; turn lisp into python, sort of
rotate-text                   ; cycle region at point between text candidates
snippets                      ; my elves. They type so I don't have to
;;word-wrap                   ; soft wrapping with language-aware indent
#+end_src

**** Builtins

#+name: doom-emacs
#+begin_src elisp
(dired +icons)                ; making dired pretty [functional]
electric                      ; smarter, keyword-based electric-indent
(ibuffer +icons)              ; interactive buffer management
(undo +tree)                  ; persistent, smarter undo for your inevitable mistakes
vc                            ; version-control and Emacs, sitting in a tree
#+end_src

**** Terminal

#+name: doom-term
#+begin_src elisp
;;eshell                      ; the elisp shell that works everywhere
;;shell                       ; simple shell REPL for Emacs
;;term                        ; basic terminal emulator for Emacs
vterm                         ; the best terminal emulation in Emacs
#+end_src

**** Checkers

#+name: doom-checkers
#+begin_src elisp
syntax                        ; tasing you for every semicolon you forget
(spell +flyspell +enchant)    ; tasing you for misspelling mispelling
;;grammar                     ; tasing grammar mistake every you make
#+end_src

**** Tools

#+name: doom-tools
#+begin_src elisp
;;ansible                     ; a crucible for infrastructure as code
;;debugger                    ; FIXME stepping through code, to help you add bugs
;;direnv                      ; be direct about your environment
docker                        ; port everything to containers
editorconfig                  ; let someone else argue about tabs vs spaces
;;ein                         ; tame Jupyter notebooks with emacs
(eval +overlay)               ; run code, run (also, repls)
;;gist                        ; interacting with github gists
lookup                        ; navigate your code and its documentation
lsp                           ; language server protocol
(magit +forge)                ; a git porcelain for Emacs
;;make                        ; run make tasks from Emacs
;;pass                        ; password manager for nerds
pdf                           ; pdf enhancements
;;prodigy                     ; FIXME managing external services & code builders
rgb                           ; creating color strings
taskrunner                    ; taskrunner for all your projects
;;terraform                   ; infrastructure as code
;;tmux                        ; an API for interacting with tmux
;;upload                      ; map local to remote projects via ssh/ftp
#+end_src

**** System

#+name: doom-os
#+begin_src elisp
(:if IS-MAC macos)            ; improve compatibility with macOS
;;tty                         ; improve the terminal Emacs experience
#+end_src

**** Language support

We can be rather liberal with enabling support for languages as the associated
packages/configuration are (usually) only loaded when first opening an
associated file.

#+name: doom-lang
#+begin_src elisp
;;agda                        ; types of types of types of types...
(cc +lsp)                     ; C/C++/Obj-C madness
;;clojure                     ; java with a lisp
;;common-lisp                 ; if you've seen one lisp, you've seen them all
;;coq                         ; proofs-as-programs
;;crystal                     ; ruby at the speed of c
;;csharp                      ; unity, .NET, and mono shenanigans
data                          ; config/data formats
;;(dart +flutter)             ; paint ui and not much else
;;elixir                      ; erlang done right
;;elm                         ; care for a cup of TEA?
emacs-lisp                    ; drown in parentheses
;;erlang                      ; an elegant language for a more civilized age
;;ess                         ; emacs speaks statistics
;;faust                       ; dsp, but you get to keep your soul
;;fsharp                      ; ML stands for Microsoft's Language
;;fstar                       ; (dependent) types and (monadic) effects and Z3
;;gdscript                    ; the language you waited for
(go +lsp)                     ; the hipster dialect
;;(haskell +dante)            ; a language that's lazier than I am
;;hy                          ; readability of scheme w/ speed of python
;;idris                       ; a language you can depend on
json                          ; At least it ain't XML
;;(java +meghanada)           ; the poster child for carpal tunnel syndrome
;;javascript                  ; all(hope(abandon(ye(who(enter(here))))))
;;julia                       ; a better, faster MATLAB
;;kotlin                      ; a better, slicker Java(Script)
;;latex                       ; writing papers in Emacs has never been so fun
;;lean                        ; proof that mathematicians need help
;;factor                      ; for when scripts are stacked against you
;;ledger                      ; an accounting system in Emacs
;;lua                         ; one-based indices? one-based indices
markdown                      ; writing docs for people to ignore
;;nim                         ; python + lisp at the speed of c
;;nix                         ; I hereby declare "nix geht mehr!"
;;ocaml                       ; an objective camel
(org +pretty)                 ; organize your plain life in plain text
;;php                         ; perl's insecure younger brother
;;plantuml                    ; diagrams for confusing people more
;;purescript                  ; javascript, but functional
;;python                      ; beautiful is better than ugly
;;qt                          ; the 'cutest' gui framework ever
;;racket                      ; a DSL for DSLs
;;raku                        ; the artist formerly known as perl6
;;rest                        ; Emacs as a REST client
;;rst                         ; ReST in peace
;;(ruby +rails)               ; 1.step {|i| p "Ruby is #{i.even? ? 'love' : 'life'}"}
;;rust                        ; Fe2O3.unwrap().unwrap().unwrap().unwrap()
;;scala                       ; java, but good
;;scheme                      ; a fully conniving family of lisps
(sh +lsp)                     ; she sells {ba,z,fi}sh shells on the C xor
;;sml                         ; no, the /other/ ML
;;solidity                    ; do you need a blockchain? No.
;;swift                       ; who asked for emoji variables?
;;terra                       ; Earth and Moon in alignment for performance.
;;web                         ; the tubes
yaml                          ; JSON, but readable
#+end_src

**** Applications

#+name: doom-email
#+begin_src elisp
;;(mu4e +org +gmail)
;;notmuch
;;(wanderlust +gmail)
#+end_src

#+name: doom-app
#+begin_src elisp
;;calendar
;;irc                        ; how neckbeards socialize
;;(rss +org)                 ; emacs as an RSS reader
;;twitter                    ; twitter client https://twitter.com/vnought
#+end_src

*** Appearance
**** Fonts

Doom exposes five (optional) variables for controlling fonts in Doom, they are:
+ doom-font
+ doom-variable-pitch-font
+ doom-serif-font
+ doom-unicode-font (the fallback font for unicode symbols that your default font doesn‚Äôt support)
+ doom-big-font (used for doom-big-font-mode)
They all accept either a font-spec, font string (=‚ÄùInput Mono-12‚Äù=), or [[https://wiki.archlinux.org/index.php/X_Logical_Font_Description][xlfd font string]].

#+begin_src elisp
(setq doom-font (font-spec :family "Fira Code" :size 12)
      doom-variable-pitch-font (font-spec :family "Fira Sans")
      doom-unicode-font (font-spec :family "Noto Sans Mono")
      doom-big-font (font-spec :family "Fira Code" :size 18))
#+end_src

**** Theme and modeline

#+begin_src elisp
(setq doom-theme 'doom-tomorrow-night)
(delq! t custom-theme-load-path) ; Remove default emacs theme from search path
#+end_src

Let's make graphical frames slightly transparent.
#+begin_src elisp
(add-to-list 'default-frame-alist '(alpha . (90 . 90)))
#+end_src

Do not show encoding in the modeline if the value is the default =LF UTF-8=.
#+begin_src elisp
(defun doom-modeline-conditional-buffer-encoding ()
  "We expect the encoding to be LF UTF-8, so only show the modeline when this is not the case"
  (setq-local doom-modeline-buffer-encoding
              (unless (or (eq buffer-file-coding-system 'utf-8-unix)
                          (eq buffer-file-coding-system 'utf-8)))))
(add-hook 'after-change-major-mode-hook #'doom-modeline-conditional-buffer-encoding)
#+end_src

**** Dashboard

Customize the splash image of the doom dashboard.
#+begin_src elisp
(setq fancy-splash-image nil
      +doom-dashboard-banner-dir (concat doom-private-dir "banner/")
      +doom-dashboard-banner-file "black-hole.png")
#+end_src

Fix visually disturbing ~hl-line~ range in the dashboard.
#+begin_src elisp
(defun doom-dashboard-hl-button ()
  (cons (- (point) 5) (line-end-position)))
(add-hook! +doom-dashboard-mode
           '(lambda () (setq-local hl-line-range-function #'doom-dashboard-hl-button)))
#+end_src

*** Terminal

Improve terminal integration. Taken from the ~tty~ module.
#+begin_src elisp
;; Some terminals offer two different cursors: a "visible" static cursor and a
;; "very visible" blinking one. By default, Emacs uses the very visible cursor
;; and will switch back to it when Emacs is started or resumed. A nil
;; `visible-cursor' prevents this.
(setq visible-cursor nil)

;; Enable the mouse in terminal Emacs
(add-hook 'tty-setup-hook #'xterm-mouse-mode)
#+end_src

Disable minor modes that are undesired in terminal frames.
#+begin_src elisp
(defun +doom-disable-graphical-modes (frame)
  "Disable undesired minor-modes in FRAME (default: selected frame)
if in terminal."
  (interactive)
  (unless (display-graphic-p frame)
    (remove-hook! doom-first-file #'centaur-tabs-mode)
    (remove-hook! doom-first-file #'beacon-mode)
    (remove-hook! doom-first-input #'evil-goggles-mode)
    (remove-hook! '(doom-dashboard-mode-hook
                    term-mode-hook
                    vterm-mode-hook)
      #'centaur-tabs-local-mode)
    (remove-hook! '(org-mode-hook
                    markdown-mode-hook
                    TeX-mode-hook
                    rst-mode-hook
                    mu4e-compose-mode-hook
                    message-mode-hook
                    git-commit-mode-hook)
      #'flyspell-mode)
    (setq +ligatures-in-modes nil)))
(add-hook! 'after-make-frame-functions '+doom-disable-graphical-modes)
#+end_src

*** Workspaces

Add an API to create default workspace names for specific applications.
#+begin_src elisp
(defun +workspace--generate-named-id (&optional prefix)
  (or (cl-loop for name in (+workspace-list-names)
               when (string-match-p (format "^%s#[0-9]+$" prefix) name)
               maximize (string-to-number (substring name (+ (length prefix) 1))) into max
               finally return (if max (1+ max)))
      1))
(cl-defun +workspace/rename-frame (name &optional (frame (selected-frame)))
  "Create a blank, new perspective and associate it with FRAME."
  (when persp-mode
    (+workspace/rename (format "%s#%s" name (+workspace--generate-named-id name)))
    (set-frame-parameter frame 'workspace (+workspace-current-name))))
#+end_src

** Better defaults
*** General

Tweak various general settings to more opinionated values.
#+begin_src elisp
(setq-default delete-by-moving-to-trash t  ; Delete files to trash
              x-stretch-cursor t)          ; Stretch cursor to the glyph width

(setq undo-limit 80000000                  ; Raise undo-limit to 80Mb
      mark-ring-max 32                     ; Set mark ring size
      global-mark-ring-max 32              ; Set global mark ring size
      set-mark-command-repeat-pop t        ; Repeat jump to last mark with just C-SPC
      max-mini-window-height 0.25          ; Increase max-height of mini-windows
      auto-save-default t                  ; Nobody likes to loose work, I certainly don't
      truncate-string-ellipsis "‚Ä¶"         ; Unicode ellispis are nicer than "...", and also save precious space
      uniquify-buffer-name-style 'forward) ; Use path to uniquify buffer names

(global-subword-mode 1)                    ; Iterate through CamelCase words
#+end_src

*** Indentation

Set default values for the various indentation settings.
Even though ~dtrt-indent~ will properly update these by analyzing existing
files, it is still necessary to set the desired value for new files.
#+begin_src elisp
(setq-default tab-width 2
              ;; List of language-specific variables from dtrt-indent
              c-basic-offset          tab-width  ; C/C++/D/PHP/Java/...
              js-indent-level         tab-width  ; JavaScript/JSON
              js2-basic-offset        tab-width  ; JavaScript-IDE
              js3-indent-level        tab-width  ; JavaScript-IDE
              lua-indent-level        tab-width  ; Lua
              perl-indent-level       tab-width  ; Perl
              cperl-indent-level      tab-width  ; Perl
              raku-indent-offset      tab-width  ; Perl6/Raku
              erlang-indent-level     tab-width  ; Erlang
              ada-indent              tab-width  ; Ada
              sgml-basic-offset       tab-width  ; SGML
              nxml-child-indent       tab-width  ; XML
              pascal-indent-level     tab-width  ; Pascal
              typescript-indent-level tab-width  ; Typescript
              ;; Languages that use SMIE-based indent
              sh-basic-offset         tab-width  ; Shell Script
              ruby-indent-level       tab-width  ; Ruby
              enh-ruby-indent-level   tab-width  ; Ruby
              crystal-indent-level    tab-width  ; Crystal (Ruby)
              css-indent-offset       tab-width  ; CSS
              rust-indent-offset      tab-width  ; Rust
              rustic-indent-offset    tab-width  ; Rust
              scala-indent:step       tab-width  ; Scala
              ;; Default fallback
              standard-indent         tab-width
              smie-indent-basic       tab-width)
#+end_src

*** Frames

Automatically maximize and focus new graphical frames.
#+begin_src elisp
(add-to-list 'default-frame-alist '(fullscreen . maximized))
(defun raise-frame-and-give-focus (&optional frame)
  (when (display-graphic-p frame)
    (raise-frame frame)
    (x-focus-frame frame)))
(add-hook 'after-make-frame-functions 'raise-frame-and-give-focus)
#+end_src

*** Windows

Focus the new window on vertical/horizontal splits.
#+begin_src elisp
(setq evil-vsplit-window-right t
      evil-split-window-below t)
#+end_src

Prompt for the workspace buffer to show on new window.
#+begin_src elisp
(defadvice! prompt-for-buffer (&rest _)
  :after '(evil-window-split evil-window-vsplit)
  (+ivy/switch-workspace-buffer))
#+end_src

*** Line numbers

Relative line numbers are fantastic for knowing how far away line numbers are,
then =12 <UP>= gets you exactly where you think.
Sadly, due to the (very) significant performance hit (mainly on scrolling),
they are disabled by default.
#+begin_src elisp
(setq display-line-numbers-type nil)
;; (setq display-line-numbers-type 'relative)
#+end_src

* Package configuration

See the [[https://github.com/hlissner/doom-emacs/blob/develop/docs/getting_started.org#configuring-doom][configuration instructions]] from the doom documentation.

** Builtin packages
*** Dired

Customize general dired appearance.
#+begin_src elisp
(use-package! dired
  :config
  (setq dired-listing-switches "--group-directories-first -lhFG -v -a")
  ;; FIXME: dired--unhide removes text properties! Use revert-buffer to restore them
  (add-hook! (dired-mode dired-hide-details-mode)
    (defun dired-hide-dir-information ()
      (unless dired-hide-details-mode
        (add-to-invisibility-spec 'dired-hide-details-information))))
  ;; Disable evil-snipe as it shadows bindings for some reason.
  (add-hook! dired-mode
    (defun dired-disable-evil-snipe ()
      (evil-snipe-local-mode 0))))

(use-package! fd-dired
  :config
  (setq find-ls-option '("-print0 | xargs -0 ls -ldhFN" . "-ldhF"))
  (setq fd-dired-ls-option '("| xargs -0 ls -ldhFN" . "-ldhF")))
#+end_src

Omit some more files from being listed.
#+begin_src elisp
(use-package! dired-x
  :config
  (setq dired-omit-files (concat dired-omit-files "\\|\\.zwc\\'")))
#+end_src

Fix issues with all-the-icons:
- Use a consistent icon height.
- Disable icons on big folders (too slow).
- Use file-local-name for remote folders.
- Fix refresh issues on some dired operations.
#+begin_src elisp
(after! all-the-icons-dired
  ;; Patch the refesh function with a :height property to fix inconsistent line height.
  (defun all-the-icons-dired--refresh ()
    "Display the icons of files in a dired buffer."
    (all-the-icons-dired--remove-all-overlays)
    ;; Don't display icons in remote folders or if the folder has too many items.
    (if (<= (count-lines (point-min) (point-max)) 150)
        (save-excursion
          (goto-char (point-min))
          (while (not (eobp))
            (when (dired-move-to-filename nil)
              (let ((file (file-local-name (dired-get-filename 'relative 'noerror))))
                (when file
                  (let ((icon (if (file-directory-p file)
                                  (all-the-icons-icon-for-dir file
                                                              :face 'all-the-icons-dired-dir-face
                                                              :height 0.9 :v-adjust all-the-icons-dired-v-adjust)
                                (all-the-icons-icon-for-file file :height 0.9 :v-adjust all-the-icons-dired-v-adjust))))
                    (if (member file '("." ".."))
                        (all-the-icons-dired--add-overlay (point) "  \t")
                      (all-the-icons-dired--add-overlay (point) (concat icon "\t")))))))
            (forward-line 1)))))
  ;; Refresh the icons after some dired operations.
  (advice-add 'dired-add-entry :around #'all-the-icons-dired--refresh-advice)
  (advice-add 'dired-remove-entry :around #'all-the-icons-dired--refresh-advice)
  (advice-add 'dired-unsubdir :around #'all-the-icons-dired--refresh-advice)
  (advice-add 'dired-undo :around #'all-the-icons-dired--refresh-advice))
#+end_src

Add facilities to quickly toggle hidden files and recursive listing.
#+begin_src elisp
(defun dired-switches-all-p (switches)
  "Return non-nil if the string SWITCHES contains -a or --all."
  (dired-check-switches switches "a" "all"))

(defun +dired-toggle-hidden-files ()
  "Toggle hidden files in dired."
  (interactive)
  (dired-sort-other
   (if (dired-switches-all-p dired-actual-switches)
       (replace-regexp-in-string " \\(-a\\|--all\\)" "" dired-actual-switches)
     (concat dired-actual-switches " -a"))))

(defun +dired-toggle-recursive ()
  "Toggle recursive subdirectory listing in dired."
  (interactive)
  (dired-sort-other
   (if (dired-switches-recursive-p dired-actual-switches)
       (replace-regexp-in-string " \\(-R\\|--recursive\\)" "" dired-actual-switches)
     (concat dired-actual-switches " -R"))))
#+end_src

Open marked files in external applications.
#+begin_src elisp
(defun dired-do-open ()
  "Open file(s) in external applications."
  (interactive)
  (let* ((files (dired-get-marked-files)))
    (xdg-open-files files)))

(defun xdg-open-files (files)
  "Open a list of files with xdg-open."
  (dolist (file files)
    (xdg-open file)))

(defun xdg-open (file)
  "Open a file with xdg-open."
  (let ((command (format "nohup xdg-open </dev/null >/dev/null 2>&1 '%s'" file)))
    (shell-command command)))
#+end_src

Subroutine to jump to a standard directory. Totally stolen from ranger.
#+begin_src elisp
(defun +dired-go (path)
  "Go subroutine"
  (interactive
   (list
    (read-char-choice
     "e   : /etc
u   : /usr
d   : /dev
l   : follow directory link
L   : follow selected file
o   : /opt
v   : /var
h   : ~/
m   : /media
M   : /mnt
s   : /srv
r,/ : /
> "
     '(?q ?e ?u ?d ?l ?L ?o ?v ?h ?m ?M ?s ?r ?/))))
  (message nil)
  (let* ((c (char-to-string path))
         (new-path
          (cl-case (intern c)
            ('e "/etc")
            ('u "/usr")
            ('d "/dev")
            ('l (file-truename default-directory))
            ('L (file-truename (dired-get-filename)))
            ('o "/opt")
            ('v "/var")
            ('h  "~/")
            ('m "/media")
            ('M "/mnt")
            ('s "/srv")
            ('r "/")
            ('/ "/"))))
    (when (string-equal c "q")
      (keyboard-quit))
    (when (and new-path (file-directory-p new-path))
      (dired new-path))))
#+end_src

Customize default bindings.
#+begin_src elisp
(map! :after dired
      :map dired-mode-map
      ;; Prefer to navigate directories horizontally rather than the buffer.
      :n "h"          #'dired-up-directory
      :n "l"          #'dired-find-file
      ;; Rebind variants for opening the current file.
      :n "<C-return>" #'dired-find-file-other-window
      :n "<S-return>" #'dired-display-file
      :n "M-RET"      #'dired-view-file
      ;; Use TAB to fold/unfold as in other modes.
      :n "TAB"        #'dired-hide-subdir
      :n "<tab>"      #'dired-hide-subdir
      :n "<backtab>"  #'dired-hide-all
      ;; Miscellaneous
      :n "_"          #'dired-undo
      :n "K"          #'dired-kill-subdir
      :n "M-J"        #'dired-goto-subdir
      :n "s"          #'dired-sort-toggle-or-edit
      :n "o"          #'dired-do-open
      :n "f"          #'dired-create-empty-file
      :n "F"          #'dired-do-find-marked-files
      :n "M-c"        #'dired-rsync
      ;; Bind missing visual-mode commands
      :v "u"          #'dired-unmark
      :localleader
      "g"             #'+dired-go
      "r"             #'+dired-toggle-recursive
      "h"             #'+dired-toggle-hidden-files
      "H"             #'dired-omit-mode)
#+end_src

*** Org

Change the default org directory.
#+begin_src elisp
(setq org-directory "~/Notes/")
#+end_src

Configure region behavior for org commands.
#+begin_src elisp
(after! org
  (setq org-loop-over-headlines-in-active-region 'start-level
        org-agenda-loop-over-headlines-in-active-region 't))
#+end_src

**** Document Structure

Configure the behavior of M-RET and friends, and ensure that headings are terminated by blank lines.
#+begin_src elisp
(after! org
  (setq org-insert-heading-respect-content nil
        org-M-RET-may-split-line '((default . t))
        org-blank-before-new-entry
        '((heading . always)
          (plain-list-item . nil))))
#+end_src

Patch doom's org-insert-item variant to better respect blank settings.
#+begin_src elisp
(after! org
  (defun +org--insert-item (direction)
    (let ((context (org-element-lineage
                    (org-element-context)
                    '(table table-row headline inlinetask item plain-list)
                    t)))
      (pcase (org-element-type context)
        ;; Add a new list item (carrying over checkboxes if necessary)
        ((or `item `plain-list)
         ;; Position determines where org-insert-todo-heading and org-insert-item
         ;; insert the new list item.
         (if (eq direction 'above)
             (org-beginning-of-item)
           (org-end-of-item)
           (backward-char))
         (org-insert-item (org-element-property :checkbox context))
         ;; Handle edge case where current item is empty and bottom of list is
         ;; flush against a new heading.
         (when (and (eq direction 'below)
                    (eq (org-element-property :contents-begin context)
                        (org-element-property :contents-end context)))
           (org-end-of-item)
           (org-end-of-line)))

        ;; Add a new table row
        ((or `table `table-row)
         (pcase direction
           ('below (save-excursion (org-table-insert-row t))
                   (org-table-next-row))
           ('above (save-excursion (org-shiftmetadown))
                   (+org/table-previous-row))))

        ;; Otherwise, add a new heading, carrying over any todo state, if
        ;; necessary.
        (_
         (let ((level (or (org-current-level) 1)))
           ;; I intentionally avoid `org-insert-heading' and the like because they
           ;; impose unpredictable whitespace rules depending on the cursor
           ;; position. It's simpler to express this command's responsibility at a
           ;; lower level than work around all the quirks in org's API.
           (pcase direction
             (`below
              (let (org-insert-heading-respect-content
                    (blank? (org--blank-before-heading-p)))
                (goto-char (line-end-position))
                (org-end-of-subtree)
                ;; FIXME: Respect blank settings, at least when inserting headlines below.
                (insert "\n")
                (unless (and blank? (org-previous-line-empty-p))
                  (org-N-empty-lines-before-current (if blank? 1 0)))
                (insert (make-string level ?*) " ")))
             (`above
              (org-back-to-heading)
              (insert (make-string level ?*) " ")
              (save-excursion (insert "\n"))))
           (when-let* ((todo-keyword (org-element-property :todo-keyword context))
                       (todo-type    (org-element-property :todo-type context)))
             (org-todo
              (cond ((eq todo-type 'done)
                     ;; Doesn't make sense to create more "DONE" headings
                     (car (+org-get-todo-keywords-for todo-keyword)))
                    (todo-keyword)
                    ('todo)))))))

      (when (org-invisible-p)
        (org-show-hidden-entry))
      (when (and (bound-and-true-p evil-local-mode)
                 (not (evil-emacs-state-p)))
        (evil-insert 1)))))
#+end_src

Add helper function to help with blank line consistency.
#+begin_src elisp
(defun +org/fix-blank-lines (&optional prefix)
  "Ensure that blank lines exist between headings and between headings and their contents.
With prefix, operate on whole buffer. Ensures that blank lines
exist after each headings's drawers."
  (interactive "P")
  (org-map-entries (lambda ()
                     (org-with-wide-buffer
                      ;; `org-map-entries' narrows the buffer, which prevents us from seeing
                      ;; newlines before the current heading, so we do this part widened.
                      (when (and (forward-line -1) (not (org-at-heading-p)) (forward-line))
                        (while (not (looking-back "\n\n" nil))
                          ;; Insert blank lines before heading.
                          (insert "\n"))))
                     (let ((end (org-entry-end-position)))
                       ;; Insert blank lines before entry content
                       (forward-line)
                       (while (and (org-at-planning-p)
                                   (< (point) (point-max)))
                         ;; Skip planning lines
                         (forward-line))
                       (while (re-search-forward org-drawer-regexp end t)
                         ;; Skip drawers. You might think that `org-at-drawer-p' would suffice, but
                         ;; for some reason it doesn't work correctly when operating on hidden text.
                         ;; This works, taken from `org-agenda-get-some-entry-text'.
                         (re-search-forward "^[ \t]*:END:.*\n?" end t)
                         (goto-char (match-end 0)))
                       (unless (or (= (point) (point-max))
                                   (org-at-heading-p)
                                   (looking-at-p "\n"))
                         (insert "\n"))))
                   t (if prefix
                         nil
                       'tree)))
#+end_src

**** TODO-items & Checkboxes

Define todo workflows and associated faces.
Use ~#+TODO~ (or ~#+SEQ_TODO~ / ~#+TYP_TODO~) to define per-file keywords
#+begin_src elisp
(after! org
  (setq org-todo-keywords
        '((sequence
           "TODO(t)"          ; A task that needs doing & is ready to do
           "ACTV(a!)"         ; A task that is active/in progress
           "WAIT(w@/!)"       ; A task that is waiting on something external
           "HOLD(h@/!)"       ; A task that is paused/on hold because of me
           "|"
           "DONE(d!/!)")      ; Task successfully completed
          (sequence
           "IDEA(i)"          ; A captured task or project that must be processed and is not yet ready to do
           "SMDY(s)"          ; A task or project that could be done someday, but should not appear in the main backlog
           "PROJ(p)"          ; A project, which usually contains other tasks/subprojects
           "|"
           "DONEPROJ(d)")
          (sequence
           "|"
           "CANCELED(c@/!)")) ; Task was aborted or is no longer applicable
        org-todo-keyword-faces
        '(("ACTV" . +org-todo-active)
          ("WAIT" . +org-todo-onhold)
          ("HOLD" . +org-todo-onhold)
          ("SMDY" . +org-todo-onhold)
          ("IDEA" . +org-todo-idea)
          ("PROJ" . +org-todo-project)))
  (custom-declare-face '+org-todo-idea '((t (:inherit (bold org-drawer org-todo)))) "")
  (custom-set-faces!
    '(+org-todo-active :inherit (bold font-lock-constant-face org-todo))
    '(+org-todo-onhold :inherit (bold warning org-todo))
    '(+org-todo-idea :inherit (bold org-formula org-todo))
    '(+org-todo-project :inherit (bold org-priority org-todo))))
#+end_src

Prefer using the ~LOGBOOK~ drawer rather than a CLOSED: entry (~org-log-done~).
#+begin_src elisp
(after! org
  (setq org-log-done nil
        org-log-repeat 'time        ; Ensure that a timestamp is logged when repeating
        org-log-redeadline 'note    ; Ask to record a note when rescheduling a deadline
        org-todo-repeat-to-state 't ; Repeat tasks to the previous state
        org-log-into-drawer "LOGBOOK"))
#+end_src

Block headings from changing to DONE if they have TODO headings that are not DONE.
#+begin_src elisp
(after! org
  (setq org-enforce-todo-dependencies 't
        org-enforce-todo-checkbox-dependencies nil))
#+end_src

Set statistics cookies to be recursive by default.
Set the ~COOKIE_DATA~ property to ~todo~ or ~checkbox~ to resolve conflicts, and
add ~recursive~ to keep the recursive behavior.
#+begin_src elisp
(after! org
  (setq org-hierarchical-todo-statistics nil
        org-checkbox-hierarchical-statistics nil))
#+end_src

Automatically change TODO item with a stats cookie to DONE when children are done.
Unfortunately it does not appear to work with checkboxes.
It also inconveniently switches headlines with no subtasks to DONE.
Kept for reference, but is probably a bad idea.
#+begin_src elisp
;; (after! org
;;   (defun org-todo-done-when-stats-full (n-done n-not-done)
;;     "Switch entry to DONE when all subentries are done."
;;     (let (org-log-done
;;           org-log-states  ; turn off logging
;;           (state (org-get-todo-state)))
;;       (when (= n-not-done 0)
;;         (cond ((equal state "PROJ")
;;                (org-todo "DONEPROJ"))
;;               ((not (equal state "DONEPROJ"))
;;                (org-todo "DONE"))
;;               ))))
;;   (add-hook! 'org-after-todo-statistics-hook #'org-todo-done-when-stats-full))
#+end_src

**** Tags

Configure default tags behavior and appearance.
#+begin_src elisp
(after! org
  ;; Default list of toplevel tags.
  ;; My org files redefine these tags for explicitness and might add their own specific tags.
  (setq org-tag-alist
        '((:startgrouptag . nil)
          ("date"         . ?1)
          (:grouptags     . nil)
          ("event"        . ?e)
          ("appointment"  . ?t)
          (:endgrouptag   . nil)
          (:startgrouptag . nil)
          ("activity"     . ?2)
          (:grouptags     . nil)
          ("read"         . ?d)
          ("listen"       . ?a)
          ("watch"        . ?w)
          (:endgrouptag   . nil)
          (:startgrouptag . nil)
          ("task"         . ?3)
          (:grouptags     . nil)
          ("issue"        . ?i)
          (:endgrouptag   . nil)
          (:startgrouptag . nil)
          ("context"      . ?4)
          (:grouptags     . nil)
          ("@self"        . ?s)
          ("@phone"       . ?p)
          ("@computer"    . ?c)
          ("@home"        . ?h)
          ("@work"        . ?w)
          ("@people"      . ?l)
          ("{@.+}"        . ?@)
          (:endgrouptag . nil))
        org-tag-faces
        ;; Teal/Blue version, matches org-formula
        '(("date"        . (:foreground "LightSkyBlue" :weight bold))
          ("activity"    . (:foreground "#b5bd68" :weight bold))
          ("task"        . (:foreground "#cc6666" :weight bold))
          ("context"     . (:foreground "#8abeb7" :weight bold))
          ;; Date tags
          ("event"       . (:foreground "LightSkyBlue" :weight bold))
          ("appointment" . (:foreground "#f0c674" :weight bold))
          ;; Activity tags
          ("read"        . (:foreground "#b5bd68" :weight bold))
          ("listen"      . (:foreground "#b5bd68" :weight bold))
          ("watch"       . (:foreground "#b5bd68" :weight bold))
          ;; Task tags
          ("issue"       . (:foreground "#cc6666" :weight bold))
          ("bug"         . (:foreground "#cc6666" :weight bold))
          ("improvement" . (:foreground "#de935f" :weight bold))
          ("feature"     . (:foreground "#b5bd68" :weight bold))
          ;; Context tags
          ("@self"       . (:foreground "#8abeb7" :weight bold))
          ("@phone"      . (:foreground "#8abeb7" :weight bold))
          ("@computer"   . (:foreground "#8abeb7" :weight bold))
          ("@home"       . (:foreground "#8abeb7" :weight bold))
          ("@work"       . (:foreground "#8abeb7" :weight bold))
          ("@people"     . (:foreground "#8abeb7" :weight bold))
          ("@errand"     . (:foreground "#8abeb7" :weight bold)))
        org-tags-column -132
        org-fast-tag-selection-single-key 't)
  (custom-set-faces!
    ;; '(org-tag :foreground "#717171" :weight normal)
    ;; '(org-tag :foreground "#de935f" :weight normal)
    '(org-tag :foreground "#8abeb7" :weight normal)
    '(org-tag-group :foreground unspecified :weight unspecified)))
#+end_src

**** Dates & Times

Configure org-habit.
#+begin_src elisp
(after! org
  (add-to-list 'org-modules 'org-habit)
  (setq org-habit-completed-glyph ?‚úî
        org-habit-today-glyph ?!))
#+end_src

**** Refiling & Archiving

Configure archiving behavior.
#+begin_src elisp
(after! org
  (setq org-archive-location "archive/%s_archive::datetree/"
        org-export-with-archived-trees nil))
#+end_src

**** TODO Chef

I *need* this in my life. It take a URL to a recipe from a common site, and
inserts an org-ified version at point. Isn't that just great.
#+begin_src elisp
;; (package! org-chef :pin "5b461ed7d458cdcbff0af5013fbdbe88cbfb13a4")
#+end_src

**** Appearance

Customize org appearance.
#+begin_src elisp
(after! org
  ;; Change the ellipsis to something prettier
  (setq org-ellipsis " ‚ñæ"))
#+end_src

Customize org-superstar.
#+begin_src elisp
(after! org-superstar
  ;; Make leading stars truly invisible, by rendering them as spaces.
  (setq org-superstar-leading-bullet ?\s
        org-superstar-leading-fallback ?\s
        org-hide-leading-stars nil
        ;; With org-indent this is also needed, otherwise the
        ;; above has no effect while indent is enabled.
        org-indent-mode-turns-on-hiding-stars nil)
  ;; Stop cycling bullets to emphasize hierarchy of headlines.
  (setq org-superstar-cycle-headline-bullets nil)
  ;; Define custom bullets.
  (setq org-superstar-headline-bullets-list
        '(?‚óâ ?‚óã ?‚óè ?‚óã ?‚óè ?‚óã ?‚óè)
        ;; '(?‚óâ ?‚óã ?‚óà ?‚ú∏ ?‚úø ?‚ú£ ?‚ñ∑)
        org-superstar-item-bullet-alist
        '((42 . ?‚Ä¢)
          (43 . ?‚û§)
          (45 . ?‚Äì)))
  ;; Disable list syntax checking for files with lots of list items.
  (defun org-superstar-auto-lightweight-mode ()
    "Start org-superstar differently depending on the number of lists items."
    (let ((list-items
           (count-matches "^[ \t]*?\\([+-]\\|[ \t]\\*\\)"
                          (point-min) (point-max))))
      (unless (< list-items 200)
        (org-superstar-toggle-lightweight-lists)))
    (org-superstar-mode))

  (remove-hook! org-mode #'org-superstar-mode)
  (add-hook! org-mode #'org-superstar-auto-lightweight-mode))
#+end_src

Customize org-fancy-priorities.
Disable for now. I find it less clear than the default letters, and it also creates tag alignment issues.
#+begin_src elisp :tangle "packages.el" :comments no
(package! org-fancy-priorities :disable t)
#+end_src
#+begin_src elisp
;; (after! org-fancy-priorities
;;   (setq org-fancy-priorities-list '("‚Äº" "‚¨Ü" "‚¨á" "‚îÅ")  ; ü†µü†∑ ‚£ø‚£∂‚£§‚£Ä
;;         org-priority-faces
;;         '((65 . error)
;;           (66 . warning)
;;           (67 . success)
;;           (68 . success)))
#+end_src

**** Bindings

Fix ~evil-org-edit-src-exit~ remove evil-write to prevent error when no filename is provided.
#+begin_src elisp
(after! evil-org
  (defun evil-org-edit-src-exit ()
    "Fallback to `evil-edit-src-exit'."
    (interactive)
    (mapc #'call-interactively '(org-edit-src-exit))))
#+end_src

Fix ~evil-save-modified-and-close~ for org-mode temporary buffers.
#+begin_src elisp
(after! evil-org
  (evil-define-command evil-save-modified-and-close (file &optional bang)
    "Saves the current buffer and closes the window."
    :repeat nil
    (interactive "<f><!>")
    (if (and (local-variable-p 'org-finish-function)
             (fboundp org-finish-function))
        (funcall org-finish-function)
      (when (buffer-modified-p)
        (evil-write nil nil nil file bang))
      (evil-quit))))
#+end_src

Restore original TAB behavior to cycle through current subtree recursively.
#+begin_src elisp
;; (after! evil-org
;;   (remove-hook 'org-tab-first-hook #'+org-cycle-only-current-subtree-h))
#+end_src

Customize bindings.
#+begin_src elisp
(after! evil-org
  (map! :map evil-org-mode-map
        ;; Prefer smart beginning of line to digit argument? (overridden)
        :m "0"                               #'evil-org-beginning-of-line
        ;; Add quick motion bindings
        :ni "C-k"     (cmds! (org-at-table-p) #'+org/table-previous-row
                             (bound-and-true-p evil-insert-state-minor-mode) #'evil-previous-line
                             #'org-backward-paragraph)
        :ni "C-j"     (cmds! (org-at-table-p) #'org-table-next-row
                             (bound-and-true-p evil-insert-state-minor-mode) #'evil-next-line
                             #'org-forward-paragraph)
        :ni "C-h"     (cmds! (org-at-table-p) #'org-table-previous-field
                             (bound-and-true-p evil-insert-state-minor-mode) #'left-char
                             #'evil-backward-word-begin)
        :ni "C-l"     (cmds! (org-at-table-p) #'org-table-next-field
                             (bound-and-true-p evil-insert-state-minor-mode) #'right-char
                             #'evil-forward-word-begin)
        ;; Prefer visible headings to same-level
        :ni "C-S-k"   (cmds! (bound-and-true-p evil-insert-state-minor-mode) #'org-backward-paragraph
                             #'org-backward-heading-same-level) ; org-previous-visible-heading)
        :ni "C-S-j"   (cmds! (bound-and-true-p evil-insert-state-minor-mode) #'org-forward-paragraph
                             #'org-forward-heading-same-level) ; org-next-visible-heading)
        ;; Allow subtree traversal
        :ni "C-S-h"   (cmds! (bound-and-true-p evil-insert-state-minor-mode) #'evil-backward-word-begin
                             #'org-up-element)
        :ni "C-S-l"   (cmds! (bound-and-true-p evil-insert-state-minor-mode) #'evil-forward-word-begin
                             #'org-down-element)

        ;; Evil replacements
        :g "C-M-k"           #'org-shiftup
        :g "C-M-j"           #'org-shiftdown
        :g "C-M-h"           #'org-shiftleft
        :g "C-M-l"           #'org-shiftright
        :g "C-M-S-k"         #'org-shiftcontrolup
        :g "C-M-S-j"         #'org-shiftcontroldown
        :g "C-M-S-h"         #'org-shiftcontrolleft
        :g "C-M-S-l"         #'org-shiftcontrolright

        :map org-mode-map
        ;; This looks like a fix for doom
        :n [S-return]        #'+org/shift-return
        :n "S-RET"           #'+org/shift-return

        ;; M-RET difficult choices
        ;; - normal-mode: org-ctrl-c-ret
        ;;   Always insert headings and not list items: straight to the point. Useful to split headings.
        ;;   More appropriate behavior in tables (or I don't understand how wrapping works)
        ;; - insert-mode: org-meta-return
        ;;   More appropriate to break an item/heading in two, supports the respect-content setting
        :gn [M-return]       #'org-ctrl-c-ret
        :gn "M-RET"          #'org-ctrl-c-ret
        :i [M-return]        #'org-meta-return
        :i "M-RET"           #'org-meta-return
        ;; This is more consistent for me
        :g [M-S-return]      #'org-insert-subheading
        :g "M-S-RET"         #'org-insert-subheading
        :g [C-M-return]      #'org-insert-todo-heading
        :g "C-M-RET"         #'org-insert-todo-heading
        :g [C-M-S-return]    #'org-insert-todo-subheading
        :g "C-M-S-RET"       #'org-insert-todo-subheading

        ;; Override +fold/close-all, it seems broken in org-mode
        :m "<backtab>"       #'org-shifttab
        :m "C-<iso-lefttab>" #'org-ctrl-c-tab

        (:localleader
         "SPC"               #'+org/fix-blank-lines
         "D"                 #'org-insert-drawer
         "H"                 #'org-list-make-subtree
         "O"                 #'org-property-action
         "X"                 #'org-toggle-radio-button
         (:prefix ("s" . "Tree/Subtree")
          "A"                #'org-archive-to-archive-sibling
          "o"                #'org-toggle-ordered-property)))
  ;; Cancel remapping of org-set-tags-command (behavior is much more complete)
  (define-key!
    [remap org-set-tags-command] nil))
#+end_src

**** Performance

Disable flyspell by default in org-mode (laggy).
#+begin_src elisp
(remove-hook! org-mode #'flyspell-mode)
#+end_src

Remove the tangle-on-save hook and add a manual binding.
#+begin_src elisp
(remove-hook! org-mode #'+literate-enable-recompile-h)
(defun +literate-recompile ()
  "Recompile literate config to `doom-private-dir"
  (interactive)
  (+literate-recompile-maybe-h))
(map! :map org-mode-map
      :localleader
      "R" #'+literate-recompile)
#+end_src

Improve org performance by removing some candy.
See [[https://github.com/hlissner/doom-emacs/blob/develop/docs/faq.org#why-is-emacsdoom-slow][this section of the doom FAQ]].
#+begin_src elisp
(after! org
  (setq org-fontify-whole-heading-line nil
        org-fontify-quote-and-verse-blocks nil))
#+end_src

*** Undo tree

Customize undo-tree visualizer.
#+begin_src elisp
(use-package! undo-tree
  :config
  (setq undo-tree-visualizer-diff nil)
  :bind (:map evil-normal-state-map
         ("U" . undo-tree-visualize)))
#+end_src

** General packages
*** Ace window

#+begin_src elisp
(after! ace-window
  (map! :leader :prefix "w"
        "a" #'ace-window))
#+end_src

*** Better jumper

Bind better-jumper functions to a doom-like alternative.
#+begin_src elisp
(after! better-jumper
  (map!
   :n "g[" #'better-jumper-jump-backward
   :n "g]" #'better-jumper-jump-forward))
#+end_src

*** Calendar

Configure localization settings.
#+begin_src elisp
(after! calendar
  (setq calendar-date-style 'european
        calendar-time-display-form
        '(24-hours ":" minutes
                   (if time-zone " (") time-zone (if time-zone ")"))
        calendar-latitude 49.61167
        calendar-longitude 6.13
        calendar-location-name "Luxembourg"))
#+end_src

**** Diary

Make holidays, diaries and today's date visible in calendar by default.
#+begin_src elisp
(after! calendar
  (setq calendar-mark-holidays-flag 't
        calendar-mark-diary-entries-flag 't)
  (add-hook! 'calendar-today-visible-hook #'calendar-mark-today))
#+end_src

Adapt sunrise/sunset diary sexp.
#+begin_src elisp
(require 'solar)

;; Sunrise (edits by Eph Zero)
;; Brady Trainor
;; http://stackoverflow.com/questions/22889036/custom-diary-sunrise-function-not-working-autoload-diary-emacs
(defun solar-sunrise-string (date &optional nolocation)
  "String of *local* time of sunrise and daylight on Gregorian DATE."
  (let ((l (solar-sunrise-sunset date)))
    (format
     "üåÖ %s (%s de jour)"
     (if (car l)
         (concat "Lever du Soleil " (apply 'solar-time-string (car l)))
       "Aucun Lever du Soleil")
     (nth 2 l))))
;; To be called from diary-list-sexp-entries, where DATE is bound.
;;;###diary-autoload
(defun diary-sunrise ()
  "Local time of sunrise as a diary entry.
Accurate to a few seconds."
  (with-no-warnings (defvar date))
  (or (and calendar-latitude calendar-longitude calendar-time-zone)
      (solar-setup))
  (solar-sunrise-string date))

;; Sunset
(defun solar-sunset-string (date &optional nolocation)
  "String of *local* time of sunset and daylight on Gregorian DATE."
  (let ((l (solar-sunrise-sunset date)))
    (format
     "üåÖ %s"
     (if (cadr l)
         (concat "Coucher du Soleil " (apply 'solar-time-string (cadr l)))
       "Aucun Coucher du Soleil"))))
;; To be called from diary-list-sexp-entries, where DATE is bound.
;;;###diary-autoload
(defun diary-sunset ()
  "Local time of sunset as a diary entry.
Accurate to a few seconds."
  (with-no-warnings (defvar date))
  (or (and calendar-latitude calendar-longitude calendar-time-zone)
      (solar-setup))
  (solar-sunset-string date))
#+end_src

Adapt solar holidays to diary-compatible expressions.
#+begin_src elisp
;;;###diary-autoload
(defun diary-equinoxes-solstices ()
  "Equinoxes/Solstices diary entry."
  (with-no-warnings (defvar displayed-month)
                    (defvar displayed-year))
  (let* ((displayed-month (calendar-extract-month date))
         (displayed-year  (calendar-extract-year  date))
         (event (solar-equinoxes-solstices)))
    (when (calendar-date-equal date (car (car event)))
      (car (cdr (car event))))))
(defun diary-daylight-saving-time ()
  "Daylight Saving Time diary entry."
  (let ((start (calendar-dst-starts (calendar-extract-year date)))
        (end (calendar-dst-ends (calendar-extract-year date))))
    (cond ((calendar-date-equal date start)
           (format "Heure d'√©t√© %s"
                   (solar-time-string
                    (/ calendar-daylight-savings-starts-time (float 60))
                    calendar-standard-time-zone-name)))
          ((calendar-date-equal date end)
           (format "Heure d'Hiver %s"
                   (solar-time-string
                    (/ calendar-daylight-savings-ends-time (float 60))
                    calendar-daylight-time-zone-name))))))
#+end_src

Add support for included diary files.
#+begin_src elisp
(after! calendar
  (add-hook 'diary-list-entries-hook #'diary-include-other-diary-files)
  (add-hook 'diary-list-entries-hook #'diary-sort-entries t)
  (add-hook 'diary-mark-entries-hook #'diary-mark-included-diary-files))
#+end_src

Add a default diary file since I will be using org mode for appointments and other diary entries.
This is a way to keep solar/lunar information available in the calendar.
#+begin_src diary :tangle ~/.local/share/emacs/etc/diary
&%%(diary-sunrise-sunset)
%%(diary-lunar-phases)
%%(diary-equinoxes-solstices)
%%(diary-daylight-saving-time)
#+end_src

**** Holidays

Customize solar/lunar phase names.
#+begin_src elisp
(after! calendar
  (setq lunar-phase-names
        '("üåï Nouvelle Lune"
          "üåì Premier Quartier de Lune"
          "üåë Pleine Lune"
          "üåó Dernier Quartier de Lune")
        solar-n-hemi-seasons
        '("Equinoxe de Printemps"
          "Solstice d'√ât√©"
          "Equinoxe d'Automne"
          "Solstice d'Hiver")))
#+end_src

Customize [[https://www.gnu.org/software/emacs/manual/html_node/emacs/Holiday-Customizing.html][holidays]].
#+begin_src elisp
(after! calendar
  (setq holiday-general-holidays
        ;; Replace most US holidays by french/european holidays
        '((holiday-fixed  1  1    "Nouvel An")
          (holiday-fixed  5  1    "F√™te du Travail")
          (holiday-fixed  5  8    "F√™te de la Victoire")
          (holiday-fixed  5  9    "Jour de l'Europe")
          (holiday-fixed  7 14    "F√™te Nationale")
          (holiday-float  5  0  2 "F√™te Nationale de Jeanne d'Arc et du Patriotisme")
          (holiday-fixed 11 11    "Jour de l'Armistice")
          ;; Selected holidays from other countries
          (holiday-fixed  6 23    "F√™te Nationale (Luxembourg)")
          (holiday-float  1  1  3 "Martin Luther King Day (US)")
          (holiday-float  2  1  3 "President's Day (US)")
          (holiday-fixed  7  4    "Independence Day (US)")
          (holiday-float 11  4  4 "Thanksgiving (US)"))
        ;; Other national/international holidays
        holiday-other-holidays
        '((holiday-fixed  2 14    "F√™te de la Saint-Valentin")
          (holiday-fixed  3  8    "Journ√©e Internationale des Femmes")
          (holiday-fixed  3 17    "F√™te de la Saint-Patrick")
          (holiday-fixed  4  1    "Jour du Poisson d'Avril")
          (holiday-fixed  4 22    "Jour de la Terre")
          (holiday-fixed  5 22    "Journ√©e Internationale de la Biodiversit√©")
          (holiday-float  5  5 -1 "F√™te des Voisins")
          (holiday-sexp  '(if (equal (holiday-easter-etc 49) (holiday-float 5 0 -1 nil))
                              (calendar-nth-named-day 1 0 6 year)
                            (calendar-nth-named-day -1 0 5 year))
                         "F√™te des M√®res")
          (holiday-float  6  0  3 "F√™te des P√®res")
          (holiday-fixed  6 21    "F√™te de la Musique")
          (holiday-float  9  6  4 "F√™te de la Gastronomie") ; Fourth week-end of september
          (holiday-fixed 11 20    "Journ√©e Internationale des droits de l'Enfant"))
        ;; Astral events are converted to diary entries.
        holiday-solar-holidays nil
        ;; Christian holidays
        holiday-christian-holidays
        '((holiday-float  1  0  1 "√âpiphanie")
          (holiday-fixed  2  2    "Chandeleur")
          (holiday-fixed  8 15    "Assomption de Marie")
          (holiday-fixed 11  1    "Toussaint")
          (holiday-fixed 11  2    "Jour des Morts")
          (holiday-advent 0       "Premier dimanche de l'Avent")
          (holiday-fixed 12  6    "Saint-Nicolas")
          (holiday-fixed 12 25    "No√´l")
          (holiday-fixed 12 26    "Saint-√âtienne")
          ;; Easter-related holidays
          (apply 'append
                 (mapcar (lambda (e) (apply 'holiday-easter-etc e))
                         '((-47 "Mardi Gras")
                           (-46 "Mercredi des Cendres")
                           (-14 "Dimanche de la Passion")
                           (-7  "Dimanche des Palmes")
                           (-4  "Mercredi Saint")
                           (-3  "Jeudi Saint")
                           (-2  "Vendredi Saint")
                           (-1  "Samedi Saint")
                           (0   "Dimanche de P√¢ques")
                           (1   "Lundi de P√¢ques")
                           (39  "Ascension")
                           (49  "Pentec√¥te")
                           (50  "Lundi de Pentec√¥te")
                           (56  "F√™te de la Sainte Trinit√©")
                           (60  "Corpus Christi")
                           (68  "F√™te du Sacr√©-C≈ìur")))))
        ;; Other cultures
        holiday-islamic-holidays
        '((holiday-islamic-new-year)
          (holiday-islamic  9  1 "Ramadan Begins")
          (holiday-islamic 10 -1 "Ramadan Ends"))
        holiday-oriental-holidays
        '((holiday-chinese-new-year))
        holiday-hebrew-holidays nil
        holiday-bahai-holidays nil))
#+end_src

**** Bindings

Disable evil-snipe.
#+begin_src elisp
(after! evil-snipe
  (add-to-list 'evil-snipe-disabled-modes 'calendar-mode))
#+end_src

Configure bindings.
#+begin_src elisp
(map! :after calendar
      :map calendar-mode-map
      :n "C-k"    #'calendar-beginning-of-month
      :n "C-j"    #'calendar-end-of-month
      :n "C-h"    #'calendar-beginning-of-week
      :n "C-l"    #'calendar-end-of-week
      :n "C-S-k"  #'calendar-backward-year
      :n "C-S-j"  #'calendar-forward-year
      :n "C-S-h"  #'calendar-backward-month
      :n "C-S-l"  #'calendar-forward-month
      :n "M-k"    #'calendar-beginning-of-month
      :n "M-j"    #'calendar-end-of-month
      :n "M-h"    #'calendar-beginning-of-week
      :n "M-l"    #'calendar-end-of-week
      :n "M-S-k"  #'calendar-backward-year
      :n "M-S-j"  #'calendar-forward-year
      :n "M-S-h"  #'calendar-backward-month
      :n "M-S-l"  #'calendar-forward-month
      :n "C-u"    #'calendar-scroll-right
      :n "C-d"    #'calendar-scroll-left

      :n "r"      #'calendar-redraw
      :n "S"      #'calendar-sunrise-sunset
      :n "M"      #'calendar-lunar-phases
      :n "H"      #'calendar-cursor-holidays
      :n "s"      nil
      :n "ss"     #'calendar-sunrise-sunset
      :n "sm"     #'calendar-lunar-phases
      :n "sh"     #'calendar-cursor-holidays
      :n "sH"     #'calendar-list-holidays

      :n "i"      nil
      :n "id"     #'diary-insert-entry
      :n "iw"     #'diary-insert-weekly-entry
      :n "im"     #'diary-insert-monthly-entry
      :n "iy"     #'diary-insert-yearly-entry
      :n "ia"     #'diary-insert-anniversary-entry
      :n "ib"     #'diary-insert-block-entry
      :n "ic"     #'diary-insert-cyclic-entry
      :n "a"      #'diary-show-all-entries

      :n [return] #'org-calendar-goto-agenda
      :n "RET"    #'org-calendar-goto-agenda

      :leader
      (:prefix-map ("o" . "open")
       :desc "Calendar" "c" #'org-goto-calendar))
#+end_src

*** Centaur tabs

Configure centaur-tabs appearance and behavior. Define rules for buffer groups
and restrict buffer list to workspace buffers.
#+begin_src elisp
(use-package! centaur-tabs
  :config
  (setq centaur-tabs-style "bar"
        centaur-tabs-height 32
        centaur-tabs-gray-out-icons nil
        centaur-tabs-set-bar 'under
        x-underline-at-descent-line t)
  (centaur-tabs-headline-match)
  ;; Override rules for grouping buffers.
  (defun centaur-tabs-buffer-groups ()
    "`centaur-tabs-buffer-groups' control buffers' group rules.

Group centaur-tabs with mode if buffer is derived from `vterm-mode'
`dired-mode' `org-mode' `magit-mode'.
All buffer name start with * will group to \"Emacs\".
Other buffer group by `centaur-tabs-get-group-name' with project name."
    (list
     (cond
      ((or (string-equal "*" (substring (buffer-name) 0 1))
           (memq major-mode '(magit-process-mode
                              magit-status-mode
                              magit-diff-mode
                              magit-log-mode
                              magit-file-mode
                              magit-blob-mode
                              magit-blame-mode
                              )))
       "Emacs")
      ((derived-mode-p 'term-mode 'vterm-mode)
       "Term")
      ;; ((derived-mode-p 'prog-mode)
      ;;  "Coding")
      ((derived-mode-p 'dired-mode)
       "Dired")
      ((memq major-mode '(org-mode org-agenda-mode diary-mode))
       "Org")
      (t
       (centaur-tabs-get-group-name (current-buffer))))))
  ;; Override centaur tabs to use workspace buffers as input list.
  (defun centaur-tabs-buffer-list ()
    "Return the list of buffers to show in tabs.
Exclude buffers whose name starts with a space, when they are not
visiting a file.  The current buffer is always included."
    (centaur-tabs-filter-out
     'centaur-tabs-hide-tab-cached
     (delq nil
           (cl-mapcar #'(lambda (b)
                          (cond
                           ;; Always include the current buffer.
                           ((eq (current-buffer) b) b)
                           ((buffer-file-name b) b)
                           ((char-equal ?\  (aref (buffer-name b) 0)) nil)
                           ((buffer-live-p b) b)))
                      (doom-buffer-list)))))
  :hook
  (doom-dashboard-mode . centaur-tabs-local-mode)
  (term-mode . centaur-tabs-local-mode)
  (vterm-mode . centaur-tabs-local-mode))
#+end_src

Provide additional bindings for centaur-tabs functions.
#+begin_src elisp
(after! centaur-tabs
  ;; Remove previous which-key descriptions.
  ;; TODO: Encapsulate in a function and use a regex.
  ;; TODO Move these bindings in a more appropriate, doom-related section
  (cl-delete-if
   (lambda (x)
     (member (car x)
             '(("\\`M-SPC b k\\'")
               ("\\`SPC b k\\'")
               ("\\`M-SPC b K\\'")
               ("\\`SPC b K\\'")
               ("\\`M-SPC b l\\'")
               ("\\`SPC b l\\'")
               ("\\`M-SPC b O\\'")
               ("\\`SPC b O\\'")
               ("\\`M-SPC b n\\'")
               ("\\`SPC b n\\'")
               ("\\`M-SPC b N\\'")
               ("\\`SPC b N\\'")
               ("\\`M-SPC b p\\'")
               ("\\`SPC b p\\'"))))
   which-key-replacement-alist)

  (map!
   ;; Rebind buffer switching to tab switching commands.
   :g [remap previous-buffer] #'centaur-tabs-backward
   :g [remap next-buffer]     #'centaur-tabs-forward
   ;; Tab manipulation
   :g "C-<next>"    #'centaur-tabs-forward
   :g "C-<prior>"   #'centaur-tabs-backward
   :g "C-M-<next>"  #'centaur-tabs-forward-group
   :g "C-M-<prior>" #'centaur-tabs-backward-group
   :n "gt"          #'centaur-tabs-forward
   :n "gb"          #'centaur-tabs-backward
   :n "gT"          #'centaur-tabs-forward-group
   :n "gB"          #'centaur-tabs-backward-group
   :n "]B"          #'centaur-tabs-forward-group
   :n "[B"          #'centaur-tabs-backward-group
   :g "C-S-<prior>" #'centaur-tabs-move-current-tab-to-left
   :g "C-S-<next>"  #'centaur-tabs-move-current-tab-to-right

   :leader :prefix "b"
   ;; Buffer group navigation
   :desc "Switch buffer group"   "g" #'centaur-tabs-counsel-switch-group
   :desc "Next buffer group"     "j" #'centaur-tabs-forward-group
   :desc "Previous buffer group" "k" #'centaur-tabs-backward-group
   ;; Tab movement
   :desc "Next tab"              "l" #'centaur-tabs-forward
   :desc "Previous tab"          "h" #'centaur-tabs-backward
   :desc "Move tab right"        "L" #'centaur-tabs-move-current-tab-to-right
   :desc "Move tab left"         "H" #'centaur-tabs-move-current-tab-to-left
   ;; Other stuff
   :desc "Kill all buffers"      "D" #'doom/kill-all-buffers
   :desc "Kill other buffers"    "K" #'doom/kill-other-buffers
   :desc ""                      "O" nil
   :desc "New empty buffer"      "n" #'evil-buffer-new
   :desc "New empty buffer"      "N" nil
   :desc ""                      "p" nil
   ;; Numbered buffer navigation
   :desc "Select tab 1..9"       "1" #'centaur-tabs-select-visible-tab
   :desc "Select tab 1..9"       "2" #'centaur-tabs-select-visible-tab
   :desc "Select tab 1..9"       "3" #'centaur-tabs-select-visible-tab
   :desc "Select tab 1..9"       "4" #'centaur-tabs-select-visible-tab
   :desc "Select tab 1..9"       "5" #'centaur-tabs-select-visible-tab
   :desc "Select tab 1..9"       "6" #'centaur-tabs-select-visible-tab
   :desc "Select tab 1..9"       "7" #'centaur-tabs-select-visible-tab
   :desc "Select tab 1..9"       "8" #'centaur-tabs-select-visible-tab
   :desc "Select tab 1..9"       "9" #'centaur-tabs-select-visible-tab
   :desc "Select last tab"       "0" #'centaur-tabs-select-end-tab
   ))
#+end_src

*** Company

Make aborting completions less annoying.
The ~evil-normal-state-entry-hook~ is triggered when the child frame opens to
describe the selected element (with ~+childframe~), so it can't be used here.
#+begin_src elisp
(after! company
  (add-hook 'evil-insert-state-exit-hook #'company-abort))
#+end_src

*** Ediff

Automatically kill unmodified buffers at the end of an ~ediff~ session.
In merge jobs, buffer C is never deleted. However, the side effect of using this
function is that you may not be able to compare the same buffer in two separate
~ediff~ sessions: quitting one of them will delete this buffer in another session
as well.
#+begin_src elisp
(after! ediff
  (setq-default ediff-keep-variants nil)
  (add-hook! 'ediff-cleanup-hook
    (defun ediff-kill-variants ()
      (ediff-janitor nil ediff-keep-variants))))
#+end_src

Automatically delete dedicated frames when quitting ~ediff~.
#+begin_src elisp
(after! ediff
  ;; Figure out if the session has a meta buffer during cleanup.
  ;; ediff-cleanup-mess seems to remove all possibilities of figuring that out.
  (defvar ediff--meta-session nil)
  (add-hook! 'ediff-cleanup-hook
    (defun ediff-mark-dedicated-frame-for-deletion ()
      (setq ediff--meta-session ediff-meta-buffer)))
  ;; Delete the current frame if it was dedicated to a simple ediff session.
  ;; This should be done after ediff-cleanup-mess.
  (add-hook! 'ediff-quit-hook :append
    (defun ediff-delete-dedicated-frame ()
      (unless ediff--meta-session
        (ediff-group-delete-dedicated-frame))))
  ;; Delete the current frame when quitting the last session group.
  (add-hook! 'ediff-quit-session-group-hook :append
    (defun ediff-group-delete-dedicated-frame ()
      (unless ediff-meta-session-number
        (when (string-match-p "^ediff#[0-9]+$" (frame-parameter nil 'workspace))
          (delete-frame))))))
#+end_src

Add evil bindings for ~ediff-meta-mode~:
#+begin_src elisp
(defvar evil-collection-ediff-registry-bindings
  '(("j" . ediff-next-meta-item)
    ("n" . ediff-next-meta-item)
    ("k" . ediff-previous-meta-item)
    ("p" . ediff-previous-meta-item)
    ("v" . ediff-registry-action)
    ("q" . ediff-quit-meta-buffer))
  "A list of bindings changed/added in evil-ediff-meta-buffer.")

(defun evil-collection-ediff-meta-buffer-startup-hook ()
  "Place evil-ediff-meta bindings in `ediff-meta-buffer-map'."
  (evil-make-overriding-map ediff-meta-buffer-map 'normal)
  (dolist (entry evil-collection-ediff-registry-bindings)
    (define-key ediff-meta-buffer-map (car entry) (cdr entry)))
  (evil-normalize-keymaps)
  nil)

(defun evil-collection-ediff-meta-buffer-setup ()
  "Initialize evil-ediff-meta-buffer."
  (interactive)
  (evil-set-initial-state 'ediff-meta-mode 'normal)
  (add-hook 'ediff-meta-buffer-keymap-setup-hook 'evil-collection-ediff-meta-buffer-startup-hook))
(evil-collection-ediff-meta-buffer-setup)
#+end_src

Customize default doom-theme faces for ~ediff~.
#+begin_src elisp
(custom-set-faces!
  '(ediff-even-diff-Ancestor    :inherit ediff-even-diff-A)
  '(ediff-odd-diff-Ancestor     :inherit ediff-even-diff-A)
  '(ediff-current-diff-Ancestor :inherit ediff-current-diff-A)
  `(ediff-current-diff-A        :background ,(doom-color 'base3))
  '(ediff-fine-diff-A           :inherit magit-diff-our-highlight :background unspecified :weight unspecified)
  '(ediff-fine-diff-B           :inherit magit-diff-their-highlight)
  '(ediff-fine-diff-C           :inherit magit-diff-base-highlight)
  `(ediff-fine-diff-Ancestor    :foreground ,(doom-color 'blue) :background ,(doom-blend 'blue 'bg 0.2) :weight bold :extend t))
#+end_src

*** Evil

Customize general evil options.
#+begin_src elisp
(setq evil-want-fine-undo t     ; By default while in insert all changes are one big blob. Be more granular
      evil-move-cursor-back nil ; Leave cursor in place when exiting insert-mode
      evil-cross-lines t)       ; Allow horizontal ops to move to the next
#+end_src

Enable evil-mode in the minibuffer. Or not.
#+begin_src elisp
;; (use-package! evil-collection
;;   :custom (evil-collection-setup-minibuffer t))
#+end_src

Customize options for evil extensions.
#+begin_src elisp
(after! evil-multiedit
  (setq evil-multiedit-follow-matches t))
#+end_src

Fix evil scroll [[https://github.com/emacs-evil/evil/issues/1322][not taking tab-bar height into account]].
#+begin_src elisp
(defun evil-posn-x-y (position)
  "Return the x and y coordinates in POSITION.
This function returns y offset from the top of the buffer area including
the header line and the tab line (on Emacs 27 and later versions).

On Emacs 24 and later versions, the y-offset returned by
`posn-at-point' is relative to the text area excluding the header
line and the tab line, while y offset taken by `posn-at-x-y' is relative to
the buffer area including the header line and the tab line.
This asymmetry is by design according to GNU Emacs team.
This function fixes the asymmetry between them.

Learned from mozc.el."
  (let ((xy (posn-x-y position)))
    (when header-line-format
      (setcdr xy (+ (cdr xy)
                    (or (and (fboundp 'window-header-line-height)
                             (window-header-line-height))
                        evil-cached-header-line-height
                        (setq evil-cached-header-line-height (evil-header-line-height))))))
    (when (fboundp 'window-tab-line-height)
      (setcdr xy (+ (cdr xy) (window-tab-line-height))))
    xy))
#+end_src

Replace evil-mc bindings by a convenient hydra.
#+begin_src elisp
(defhydra evil-mc-hydra (:color pink
                         :hint nil
                         :pre (evil-mc-pause-cursors))
  "
^Match^            ^Line-wise^           ^Manual^
^^^^^^----------------------------------------------------
_a_: match all     _J_: make & go down   _z_: toggle here
_m_: make & next   _K_: make & go up     _r_: remove last
_M_: make & prev   ^ ^                   _R_: remove all
_n_: skip & next   ^ ^                   _p_: pause/resume
_N_: skip & prev

Current pattern: %`evil-mc-pattern

"
  ("a" #'evil-mc-make-all-cursors)
  ("m" #'evil-mc-make-and-goto-next-match)
  ("M" #'evil-mc-make-and-goto-prev-match)
  ("n" #'evil-mc-skip-and-goto-next-match)
  ("N" #'evil-mc-skip-and-goto-prev-match)
  ("J" #'evil-mc-make-cursor-move-next-line)
  ("K" #'evil-mc-make-cursor-move-prev-line)
  ("z" #'+multiple-cursors/evil-mc-toggle-cursor-here)
  ("r" #'+multiple-cursors/evil-mc-undo-cursor)
  ("R" #'evil-mc-undo-all-cursors)
  ("p" #'+multiple-cursors/evil-mc-toggle-cursors)
  ("q" #'evil-mc-resume-cursors "quit" :color blue)
  ("<escape>" #'evil-mc-resume-cursors "quit" :color blue))
#+end_src

Provide more consistent navigation bindings and add missing evil bindings.
Add the missing arrow-key variants of the window navigation commands.
#+begin_src elisp
(map!
 ;; Bind missing evil bindings
 :nv "gX"             #'evil-exchange-cancel
 :nv "god"            #'evil-quick-diff
 :nv "goD"            #'evil-quick-diff-cancel
 :textobj "b"         #'evil-textobj-anyblock-inner-block #'evil-textobj-anyblock-a-block
 ;; Rebind fold commands
 :m "TAB"             #'+fold/toggle
 :m "<tab>"           #'+fold/toggle
 :m "<backtab>"       #'+fold/close-all
 :m "C-<iso-lefttab>" #'+fold/open-all
 ;; Rebind macro command, q is for quitting.
 :n "q"               nil
 :n "zq"              #'evil-record-macro
 ;; Use M-/ to toggle comments (M-; for comment-dwim), rebind dabbrev-expand
 :nv "M-/"            #'evilnc-comment-or-uncomment-lines
 :g  "C-/"            #'dabbrev-expand
 ;; Rebind evil-lion to ga (align) to avoids gl conflicts with org-mode
 :nv "ga"             #'evil-lion-left
 :nv "gA"             #'evil-lion-right
 :nv "gl"             nil
 :nv "gL"             nil
 (:when (featurep! :editor multiple-cursors)
  :prefix "g"
  :nv "z"             #'evil-mc-hydra/body)
 ;; Use more consistent bindings for workspaces/window navigation
 :m "] TAB"           #'+workspace/switch-right
 :m "[ TAB"           #'+workspace/switch-left
 :nm "]w"             #'evil-window-next
 :nm "[w"             #'evil-window-prev
 ;; Bind more motion/editing commands to hjkl
 :i "C-k"             #'evil-previous-line
 :i "C-j"             #'evil-next-line
 :i "C-h"             #'left-char
 :i "C-l"             #'right-char
 :m "C-k"             #'evil-backward-paragraph
 :m "C-j"             #'evil-forward-paragraph
 :m "C-h"             #'evil-backward-word-begin
 :m "C-l"             #'evil-forward-word-begin
 :i "C-S-k"           #'evil-backward-paragraph
 :i "C-S-j"           #'evil-forward-paragraph
 :i "C-S-h"           #'evil-backward-word-begin
 :i "C-S-l"           #'evil-forward-word-begin
 :m "C-S-k"           #'evil-backward-section-end
 :m "C-S-j"           #'evil-forward-section-end
 :m "C-S-h"           #'evil-backward-WORD-begin
 :m "C-S-l"           #'evil-forward-WORD-end
 :g "M-k"             #'drag-stuff-up
 :g "M-j"             #'drag-stuff-down
 :g "M-h"             #'evil/shift-left
 :g "M-l"             #'evil-shift-right
 :g "M-K"             #'drag-stuff-up
 :g "M-J"             #'drag-stuff-down
 :g "M-H"             #'drag-stuff-left
 :g "M-L"             #'drag-stuff-right
 :map evil-window-map
 ;; Navigation
 "]"                  #'evil-window-next
 "["                  #'evil-window-prev
 "<left>"             #'evil-window-left
 "<down>"             #'evil-window-down
 "<up>"               #'evil-window-up
 "<right>"            #'evil-window-right
 ;; Moving windows
 "S-<left>"           #'+evil/window-move-left
 "S-<down>"           #'+evil/window-move-down
 "S-<up>"             #'+evil/window-move-up
 "S-<right>"          #'+evil/window-move-right
 ;; Miscellaneous
 "`"                  #'evil-window-mru     ; Consistent with SPC `
 "p"                  #'+popup/other        ; Better than C-x p
 "c"                  nil                   ; Confusing, use 'd'
 )
#+end_src

*** Evil goggles

Customize evil-goggles visual hints.
#+begin_src elisp
(use-package! evil-goggles
  :config
  (custom-set-faces!
    '(evil-goggles-paste-face  :inherit custom-state)
    '(evil-goggles-indent-face :inherit custom-modified)
    '(evil-goggles-change-face :inherit custom-invalid)
    '(evil-goggles-delete-face :inherit custom-invalid))
  (setq evil-goggles-enable-delete t
        evil-goggles-enable-change t))
#+end_src

*** Flyspell

Provide language cycling.
#+begin_src elisp
(defvar-local lang-ring nil
  "The list of available ispell languages.")

(let ((langs '("fr_FR" "en_US")))
  (let ((ring (make-ring (length langs))))
    (dolist (elem langs) (ring-insert ring elem))
    (setq-default lang-ring ring)))

(defun +spell/cycle-languages ()
  "Cycle between ispell languages for the current buffer."
  (interactive)
  (setq-local lang-ring (ring-copy lang-ring))
  (let ((lang (ring-ref lang-ring -1)))
    (ring-insert lang-ring lang)
    (ispell-change-dictionary lang)))

(map! :leader :prefix "n"
      :desc "Cycle ispell languages" "L" #'+spell/cycle-languages)
#+end_src

*** Format

Override format-on-save default enabled modes to add emacs-lisp-mode.
#+begin_src elisp
(setq +format-on-save-enabled-modes
      '(not sql-mode         ; sqlformat is currently broken
            tex-mode         ; latexindent is broken
            latex-mode))
#+end_src

Disable ~shfmt~ formatting for zsh buffers (not supported).
#+begin_src elisp
(add-hook! 'sh-set-shell-hook
  (defun +sh-shell-zsh-no-format ()
    (if (string= sh-shell "zsh")
        (setq +format-with :none)
      (setq +format-with nil))))
#+end_src

Redefine the ~shfmt~ formatter with consistent indent settings.
Also format ~zsh~ regions using bash syntax by default (org-mode code snippets).
#+begin_src elisp
(set-formatter! 'shfmt
  '("shfmt"
    "-s"   ; simplify the code
    "-bn"  ; binary ops like && and | may start a line
    ("-i" "%d" tab-width)
    ("-ln" "%s" (cl-case (and (eql major-mode 'sh-mode)
                              (boundp 'sh-shell)
                              (symbol-value 'sh-shell))
                  (zsh "bash")
                  (bash "bash")
                  (mksh "mksh")
                  (t "posix"))))
  :modes 'sh-mode)
#+end_src

*** Ivy

Enable Ivy buffer previews. This only applies to workspace buffer switching,
as it seems that previewing buffers from other workspaces adds them to the
current workspace, which is totally unwanted behavior.
#+begin_src elisp
(setq +ivy-buffer-preview t)
#+end_src

Override doom's ~+ivy-format-function-line-or-arrow~ and use the line highlight,
even in terminal mode.
#+begin_src elisp
(after! ivy
  (setf (alist-get 't ivy-format-functions-alist)
        #'ivy-format-function-line))
#+end_src

Use a cache for ivy-rich transformations on ~switch-buffer~.
See the [[https://github.com/Yevgnen/ivy-rich/issues/87][related issue]].
#+begin_src elisp
(after! ivy-rich
  (defvar ivy-rich--ivy-switch-buffer-cache
    (make-hash-table :test 'equal))

  (define-advice ivy-rich--ivy-switch-buffer-transformer
      (:around (old-fn x) cache)
    (let ((ret (gethash x ivy-rich--ivy-switch-buffer-cache)))
      (unless ret
        (setq ret (funcall old-fn x))
        (puthash x ret ivy-rich--ivy-switch-buffer-cache))
      ret))

  (define-advice +ivy/switch-buffer
      (:before (&rest _) ivy-rich-reset-cache)
    (clrhash ivy-rich--ivy-switch-buffer-cache)))
#+end_src

Extend the default hydra for ivy.
#+begin_src elisp
(after! ivy-hydra
  (defhydra+ hydra-ivy (:hint nil :color pink)
    "
 Move     ^^^^^^^^^^ | Call         ^^^^ | Cancel^^ | Options^^ | Action _w_/_s_/_a_: %s(ivy-action-name)
----------^^^^^^^^^^-+--------------^^^^-+-------^^-+--------^^-+---------------------------------
 _g_ ^ ^ _k_ ^ ^ _u_ | _f_orward _o_ccur | _i_nsert | _c_alling: %-7s(if ivy-calling \"on\" \"off\") _C_ase-fold: %-10`ivy-case-fold-search
 ^‚Ü®^ _h_ ^+^ _l_ ^‚Üï^ | _RET_ done     ^^ | _q_uit   | _M_atcher: %-7s(ivy--matcher-desc) _T_runcate: %-11`truncate-lines
 _G_ ^ ^ _j_ ^ ^ _d_ | _TAB_ alt-done ^^ | ^ ^      | _<_/_>_: shrink/grow _m_ark _t_oggle _u_nmark
"
    ;; Movement
    ("l" ivy-alt-done)
    ("h" ivy-backward-delete-char)
    ;; Restore mark bindings
    ("m" ivy-mark)
    ("u" ivy-unmark)
    ("<deletechar>" ivy-unmark-backward)
    ("t" ivy-toggle-marks)
    ;; Actions
    ("<escape>" nil)
    ("M-o" nil)
    ("K" (ivy-exit-with-action #'ivy--kill-buffer-action))
    ))
#+end_src

Customize bindings.
#+begin_src elisp
(after! ivy
  (map! :map ivy-minibuffer-map
        "C-<return>" #'ivy-immediate-done))
#+end_src

*** Ligatures

Remove annoying programming ligatures.
#+begin_src elisp
(cl-delete-if
 (lambda (x)
   (member (car x)
           '("[]"
             "##"
             "###"
             "####")))
 +ligatures-fira-font-alist)
#+end_src

*** Lsp

Ignore prompts to restart server to avoid hangs on server-restart.
#+begin_src elisp
(after! lsp-mode
  (setq-default lsp-restart 'auto-restart))
#+end_src

*** Magit

Enable gravatars when viewing commits. The service used by default is [[https://www.libravatar.org/][Libravatar]].
#+begin_src elisp
(after! magit
  :config
  (setq git-commit-summary-max-length 72)
  (setq magit-revision-show-gravatars '("^Author:     " . "^Commit:     ")))
#+end_src

Customize bindings.
#+begin_src elisp
(map! :leader :prefix "g"
      "m" nil) ; unbind smerge hydra - use ediff instad.
#+end_src

*** Man

Add shortcut to man command.
#+begin_src elisp
(use-package! man
  :config
  (map! :leader :prefix "h"
        "H" #'man))
#+end_src

*** Projectile

Customize general projectile options.
#+begin_src elisp
(after! projectile
  :config
  (setq projectile-track-known-projects-automatically nil
        ;; Open dired when switching projects
        projectile-switch-project-action #'projectile-dired
        ;; Make compilation buffers project-specific
        compilation-buffer-name-function #'projectile-compilation-buffer-name
        compilation-save-buffers-predicate #'projectile-current-project-buffer-p))
#+end_src

Add project name and type in the modeline.
#+begin_src elisp
(defcustom projectile-mode-line-info nil
  "Format for displaying the project in the mode line."
  :type 'sexp)
;; Ensure we can display text properties on this value in the mode line.
;; See (info "(elisp) Mode Line Data") or (info "(elisp) Properties in Mode").
(put 'projectile-mode-line-info 'risky-local-variable t)

(after! projectile
  :config
  ;; Custom projectile modeline format.
  (defun projectile-custom-mode-line ()
    "Report project name and type in the modeline."
    (let ((project-name (projectile-project-name))
          (project-type (projectile-project-type)))
      (format "%s%s"
              (if (not (equal project-name "-"))
                  project-name
                "")
              (if project-type
                  (format ":%s" project-type)
                ""))))
  (setq-default projectile--mode-line nil)
  (setq projectile-mode-line-function 'projectile-custom-mode-line)
  (setq projectile-dynamic-mode-line t)

  ;; Propertize projectile modeline.
  (defun projectile-mode-line-info ()
    "Return the mode line construct for variable `projectile--mode-line'."
    (let ((map (make-sparse-keymap)))
      (define-key map (kbd "<mode-line> <down-mouse-1>")
        `(menu-item "" nil
                    :filter ,(lambda (_cmd) (projectile-commander))))
      `(projectile--mode-line
        ("" (:eval (propertize projectile--mode-line
                               'face 'doom-modeline-persp-name
                               'mouse-face 'mode-line-highlight
                               'keymap ',map
                               'help-echo "Projectile project:type, mouse-1: Run projectile-commander"))
         ))))
  (setq projectile-mode-line-info (projectile-mode-line-info))
  (nconc mode-line-misc-info '((projectile-mode ("" projectile-mode-line-info " ")))))
#+end_src

Customize bindings.
#+begin_src elisp
(after! (projectile which-key)
  ;; Remove previous which-key descriptions.
  ;; TODO: Encapsulate in a function and use a regex.
  (cl-delete-if
   (lambda (x)
     (member (car x)
             '(("\\`M-SPC p t\\'")
               ("\\`SPC p t\\'")
               ("\\`M-SPC p g\\'")
               ("\\`SPC p g\\'")
               ("\\`M-SPC p D\\'")
               ("\\`SPC p D\\'")
               ("\\`M-SPC p C\\'")
               ("\\`SPC p C\\'"))))
   which-key-replacement-alist)
  (map! :leader :prefix "p"
        ;; Adapt default bindings
        :desc "List project todos"           "l"   #'magit-todos-list
        :desc "Find test file"               "t"   #'projectile-find-test-file
        :desc "Search project with git grep" "g"   #'counsel-projectile-git-grep
        :desc "Discover projects in folder"  "A"   #'+default/discover-projects
        :desc "Compile in project"           "B"   #'+ivy/project-compile
        :desc "Configure project"            "C"   #'projectile-configure-project
        :desc "Install project"              "I"   #'projectile-install-project
        :desc "Run GDB in project"           "D"   #'projectile-run-gdb
        :desc "Repeat last command"          ";"   #'projectile-repeat-last-command
        ;; Bind additional commands.
        :desc "Find impl/test"               "O"   #'projectile-find-implementation-or-test
        :desc "Replace in project"           "%"   #'projectile-replace
        :desc "Replace regexp in project"    "M-%" #'projectile-replace-regexp
        :desc "Open dired"                   "-"   #'projectile-dired))
#+end_src

*** Treemacs

Configure treemacs appearance and behavior.
#+begin_src elisp
(use-package! treemacs
  :init
  (setq doom-themes-treemacs-theme "all-the-icons"
        +treemacs-git-mode 'deferred)
  :config
  (setq treemacs-recenter-after-file-follow 'always)
  (custom-set-faces!
    '(treemacs-root-face :inherit (variable-pitch font-lock-builtin-face))
    '(treemacs-all-the-icons-root-face :inherit font-lock-builtin-face)
    '(treemacs-fringe-indicator-face :inherit cursor)))
#+end_src

Customize bindings.
#+begin_src elisp
(after! treemacs-evil
  (defun treemacs-toggle-node-nested ()
    (interactive)
    (treemacs-toggle-node "0"))
  (defun treemacs-visit-node-nofocus ()
    (interactive)
    (treemacs-visit-node-default "0"))
  (evil-define-key* 'treemacs treemacs-mode-map
    (kbd "h")          #'treemacs-goto-parent-node
    (kbd "l")          #'treemacs-toggle-node
    (kbd "<")          #'treemacs-root-up
    (kbd ">")          #'treemacs-root-down
    (kbd "L")          #'treemacs-toggle-node-nested
    (kbd "C")          #'treemacs-copy-file
    (kbd "M")          #'treemacs-move-file
    (kbd "x")          #'treemacs-delete
    (kbd "<S-return>") #'treemacs-visit-node-nofocus
    (kbd "<M-return>") #'treemacs-peek)
  (map! :map treemacs-mode-map "d" nil "m" nil))
#+end_src

*** Vterm

Configure vterm buffer naming scheme.
#+begin_src elisp
(use-package! vterm
  :config
  (setq vterm-buffer-name-string "vterm %s"))
#+end_src

*** Which-key

Reduce the delay before the which-key buffer is displayed.
#+begin_src elisp
(after! which-key
  (setq which-key-idle-delay 0.5))
#+end_src

Replace =evil-= like prefixes by a unicode symbol to reduce verbosity.
#+begin_src elisp
(setq which-key-allow-multiple-replacements t)
(after! which-key
  (pushnew!
   which-key-replacement-alist
   '(("" . "\\`+?evil[-/:]?\\(?:a-\\)?\\(.*\\)") . (nil . "‚Äπ\\1"))
   '(("\\`g s" . "\\`evilem--?motion-\\(.*\\)") . (nil . "¬´\\1"))
   ))
#+end_src

*** YASnippet

Nested snippets are good, enable that.
#+begin_src elisp
(use-package! yasnippet
  :config
  (setq yas-triggers-in-field t))
#+end_src

Rebind auto-yasnippet commands.
#+begin_src elisp
(use-package! auto-yasnippet
  :config
  (map!
   :nvi [C-tab] nil
   (:leader :prefix "c"
    :desc "Expand auto-snippet" "y" #'aya-expand
    :desc "Create auto-snippet" "Y" #'aya-create)))
#+end_src

** Language packages
*** Sh

Integrate lsp-mode with Flycheck `sh-shellcheck' checker. It will become
redundant if bash-language-server implements
https://github.com/bash-lsp/bash-language-server/issues/104
#+begin_src elisp
(defun lsp-flycheck-enable-shellcheck ()
  "Enable Shellcheck for shell buffers under LSP."
  (when (derived-mode-p 'sh-mode)
    (flycheck-add-next-checker 'lsp 'sh-shellcheck)))

(add-hook 'lsp-after-open-hook #'lsp-flycheck-enable-shellcheck)
#+end_src

* Additional packages
:PROPERTIES:
:header-args:elisp: :tangle "packages.el" :comments no
:END:

See the [[https://github.com/hlissner/doom-emacs/blob/develop/docs/getting_started.org#package-management][package management instructions]] from the doom documentation.

This file shouldn't be byte compiled.
#+begin_src elisp
;;; packages.el -*- no-byte-compile: t; -*-
#+end_src

** General packages
*** Beacon

[[https://github.com/Malabarba/beacon][This package]] provides a light that follows the cursor so that I don't lose it.
#+begin_src elisp
(package! beacon)
#+end_src

#+begin_src elisp :tangle yes
(use-package! beacon
  :config
  (setq beacon-color 0.7
        beacon-size 24
        beacon-blink-delay 0.2
        beacon-blink-duration 0.2)
  (nconc beacon-dont-blink-commands
         '(evil-ex-search-next
           evil-ex-search-previous
           evil-ex-search-forward
           evil-ex-search-backward
           evil-ex-search-word-forward
           evil-ex-search-word-backward))
  ;; FIXME: Persp-mode must be doing something after the hook that cancels the blink.
  ;; (add-hook! 'persp-activated-functions
  ;;   (defun beacon--on-persp-activate (_target)
  ;;     (beacon-blink-automated)))
  (add-hook! doom-first-file #'beacon-mode))
#+end_src

*** Command logging

[[https://github.com/lewang/command-log-mode][This package]] allows logging of the commands executed by emacs for some or all buffers.
#+begin_src elisp
(package! command-log-mode)
#+end_src

*** Evil visual mark

[[https://github.com/roman/evil-visual-mark-mode][This package]] displays all the evil markers in the current buffer.
FIXME: Does not support ~evil-delete-marks~.
#+begin_src elisp
(package! evil-visual-mark-mode)
#+end_src

Customize, disabled by default for now as I often mistype and set marks unwillingly. Enable as needed.
#+begin_src elisp :tangle yes
(use-package! evil-visual-mark-mode
  :config
  (custom-set-faces!
    '(evil-visual-mark-face :weight bold :foreground "#0d0d0d" :background "#de935f"))
  ;; (evil-visual-mark-mode)
)
#+end_src

*** Evil terminal cursor

[[https://github.com/amosbird/evil-terminal-cursor-changer][This package]] changes the cursor shape based on the current evil mode in terminal.
#+begin_src elisp
(package! evil-terminal-cursor-changer
  ;; HACK Original package is abandoned. This fork greatly simplifies
  ;; and optimizes the implementation by relying on evil-set-cursor.
  :recipe (:host github :repo "amosbird/evil-terminal-cursor-changer"))
#+end_src

#+begin_src elisp :tangle yes
(add-hook! 'tty-setup-hook #'evil-terminal-cursor-changer-activate)
;; Restore my default terminal cursor.
(add-hook! 'delete-terminal-functions
  (defun +doom-restore-terminal-cursor (terminal)
    (unless (display-graphic-p terminal)
      (etcc--apply-to-terminal (etcc--make-cursor-shape-seq 'bar)))))
#+end_src

*** Fasd

[[https://framagit.org/steckerhalter/emacs-fasd][This package]] provides integration with [[https://github.com/clvv/fasd][fasd]].
#+begin_src elisp
(package! fasd)
#+end_src

#+begin_src elisp :tangle yes
(use-package! fasd
  :config
  (map! :leader
        :desc "Find frecent file" ">" #'fasd-find-file)
  (global-fasd-mode))
#+end_src

*** Fast scroll

[[https://github.com/ahungry/fast-scroll][This package]] temporarily disables font-lock and switches to a bare-bones
modeline during intense scrolling operations.
#+begin_src elisp
(package! fast-scroll)
#+end_src

#+begin_src elisp :tangle yes
(use-package! fast-scroll
  :config
  (setq fast-scroll-throttle 0.1)
  ;; Add scroll-up/down commands for mouse wheel.
  (defun fast-scroll-advice-scroll-functions ()
    "Wrap as many scrolling functions that we know of in this advice."
    (interactive)
    (advice-add #'scroll-up-command :around #'fast-scroll-run-fn-minimally)
    (advice-add #'scroll-down-command :around #'fast-scroll-run-fn-minimally)
    (advice-add #'evil-scroll-up :around #'fast-scroll-run-fn-minimally)
    (advice-add #'evil-scroll-down :around #'fast-scroll-run-fn-minimally)
    (advice-add #'scroll-up :around #'fast-scroll-run-fn-minimally)
    (advice-add #'scroll-down :around #'fast-scroll-run-fn-minimally))
  (defun fast-scroll-unload-function ()
    "Remove advice added by `fast-scroll-advice-scroll-functions'.
Note this function's name implies compatibility with `unload-feature'."
    (interactive)
    (advice-remove #'scroll-up-command #'fast-scroll-run-fn-minimally)
    (advice-remove #'scroll-down-command #'fast-scroll-run-fn-minimally)
    (advice-remove #'evil-scroll-up #'fast-scroll-run-fn-minimally)
    (advice-remove #'evil-scroll-down #'fast-scroll-run-fn-minimally)
    (advice-remove #'scroll-up #'fast-scroll-run-fn-minimally)
    (advice-remove #'scroll-down #'fast-scroll-run-fn-minimally)
    nil)
  ;; Remove modes from default modeline.
  (defun fast-scroll-default-mode-line ()
    "An Emacs default/bare bones mode-line."
    (list "%e" mode-line-front-space
          mode-line-client
          mode-line-modified
          mode-line-frame-identification
          mode-line-buffer-identification "   "
          mode-line-position
          "  " mode-line-misc-info mode-line-end-spaces))
  ;; Bind mouse button to toggle mode.
  (map! :g "<mouse-8>" #'fast-scroll-mode))
#+end_src

*** Info colors

[[https://github.com/ubolonton/info-colors][This package]] makes info pages nicer to look at with variable pitch fontification + coloring.
#+begin_src elisp
(package! info-colors :pin "47ee73cc19")
#+end_src

#+begin_src elisp :tangle yes
(use-package! info-colors
  :after info
  :hook (Info-selection . info-colors-fontify-node))
#+end_src

*** TODO Large files

The [[https://github.com/m00natic/vlfi][/very large files/ mode]] loads large files in chunks, allowing one to open
ridiculously large files.
#+begin_src elisp
;; (package! vlf
;;   :recipe (:host github :repo "m00natic/vlfi" :files ("*.el"))
;;   :pin "cc02f25337" :disable t)
#+end_src

To make VLF available without delaying startup, just load it in quiet moments.
#+begin_src elisp :tangle yes
;; (use-package! vlf-setup
;;   :defer-incrementally vlf-tune vlf-base vlf-write vlf-search vlf-occur vlf-follow vlf-ediff vlf)
#+end_src

*** Magit delta

[[https://github.com/dandavison/delta/][Delta]] is a git diff syntax highlighter written in rust. The author also wrote a
package to hook this into the magit diff view. This requires the ~delta~ binary.
FIXME: Breaks log view for a particular file with patch (^L characters on commit line)
#+begin_src elisp
(package! magit-delta)
#+end_src

#+begin_src elisp :tangle yes
(use-package! magit-delta
  :after magit
  :config
  (setq magit-delta-delta-args
        '("--features" "truecolor"
          "--max-line-distance" "0.6"
          "--24-bit-color" "always"
          "--color-only"))
  (magit-delta-mode))
#+end_src

*** Scroll on jump
[[https://gitlab.com/ideasman42/emacs-scroll-on-jump][This package]] allows to control the scrolling on any operation that jumps to a new location.
#+begin_src elisp
(package! scroll-on-jump :recipe
  (:host gitlab
   :repo "ideasman42/emacs-scroll-on-jump"))
#+end_src

Define a global mode for scroll-on-jump and bind to relevant commands.
#+begin_src elisp :tangle yes
(use-package! scroll-on-jump
  :after evil
  :hook (doom-first-file . scroll-on-jump-mode)
  :config
  (setq scroll-on-jump-duration 0.4)

  ;; XXX: For some really obscure reason, the order in which these functions
  ;; are declared defines which one will actually work. Currently turning off
  ;; doesn't work, unless this code is re-evaluated from the emacs instance.
  ;; If the turn-off function is declared after the turn-on, then turning on
  ;; will similarly not work. Someone help me understand this plz.
  (defun scroll-on-jump--turn-off ()
    (scroll-on-jump-advice-remove set-mark-command)
    (scroll-on-jump-advice-remove goto-last-change)
    (scroll-on-jump-advice-remove goto-last-change-reverse)
    (scroll-on-jump-advice-remove evil-undo)
    (scroll-on-jump-advice-remove evil-redo)
    ;; (scroll-on-jump-advice-remove evil-goto-mark)
    (scroll-on-jump-advice-remove evil-goto-mark-line)
    (scroll-on-jump-advice-remove evil-ex-search-next)
    (scroll-on-jump-advice-remove evil-ex-search-previous)
    (scroll-on-jump-advice-remove evil-ex-search-forward)
    (scroll-on-jump-advice-remove evil-ex-search-backward))
  (defun scroll-on-jump--turn-on ()
    (scroll-on-jump-advice-add set-mark-command)
    (scroll-on-jump-advice-add goto-last-change)
    (scroll-on-jump-advice-add goto-last-change-reverse)
    (scroll-on-jump-advice-add evil-undo)
    (scroll-on-jump-advice-add evil-redo)
    ;; (scroll-on-jump-advice-add evil-goto-mark) ; Also triggers on paste - undesired
    (scroll-on-jump-advice-add evil-goto-mark-line)
    (scroll-on-jump-advice-add evil-ex-search-next)
    (scroll-on-jump-advice-add evil-ex-search-previous)
    (scroll-on-jump-advice-add evil-ex-search-forward)
    (scroll-on-jump-advice-add evil-ex-search-backward))

  (define-minor-mode scroll-on-jump-mode
    "Minor-mode to animate scroll and recenter when the point jumps."
    :group 'scroll-on-jump
    :global t
    (if scroll-on-jump-mode
        (scroll-on-jump--turn-on)
      (scroll-on-jump--turn-off))))
#+end_src

*** Systemd

[[https://github.com/holomorph/systemd-mode][This package]] provides a major mode for editing systemd unit files.
#+begin_src elisp
(package! systemd :pin "51c148e09a")
#+end_src

*** TLDR

[[https://github.com/kuanyui/tldr.el][This package]] provides a [[https://github.com/tldr-pages/tldr][tldr-pages]] client.
#+begin_src elisp
(package! tldr)
#+end_src

Disable font-lock mode in tldr-mode buffers.
#+begin_src elisp :tangle yes
(use-package! tldr
  :config
  (add-hook! tldr-mode '(lambda () (font-lock-mode 0)))
  (map! :leader :prefix "h"
        "h" #'tldr))
#+end_src

*** Treemacs icons

[[https://github.com/Alexander-Miller/treemacs/tree/c8f70f119f0deb1100b0d91a0e3c488ffd9cd63b#treemacs-all-the-icons][This package]] provides a treemacs theme using all-the-icons.
#+begin_src elisp
(package! treemacs-all-the-icons)
#+end_src

#+begin_src elisp :tangle yes
(use-package! treemacs-all-the-icons
  :after treemacs)
#+end_src

*** Window layouts

[[https://github.com/daichirata/emacs-rotate][This package]] allows rotating between window layouts.
#+begin_src elisp
(package! rotate :pin "091b5ac4fc")
#+end_src

#+begin_src elisp :tangle yes
(map! :map evil-window-map
 "\\" #'rotate-layout)
#+end_src

*** Xclip

[[https://elpa.gnu.org/packages/xclip.html][This package]] enables clipboard integration in terminal emacs.
#+begin_src elisp
(package! xclip :pin "2951c6b62b")
#+end_src

#+begin_src elisp :tangle yes
(add-hook! 'tty-setup-hook
  (defun doom-init-clipboard-in-tty-emacs-h ()
    ;; Fix the clipboard in tty Emacs by piping clipboard I/O through xclip,
    ;; xsel, pb{copy,paste}, wl-copy, termux-clipboard-get, or getclip (cygwin);
    ;; depending on what is available.
    (and (require 'xclip nil t)
         (xclip-mode +1))))
#+end_src

** Language packages
